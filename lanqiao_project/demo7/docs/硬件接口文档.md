# 硬件接口文档

## 📋 目录

- [硬件概述](#硬件概述)
- [引脚定义](#引脚定义)
- [外设接口](#外设接口)
- [电路原理](#电路原理)
- [时序分析](#时序分析)

---

## 硬件概述

### 主控芯片

**型号：** STC15F2K60S2

**主要特性：**
- 8051 内核，增强型 MCS-51 单片机
- 工作频率：12MHz
- 程序存储器：60KB Flash
- 数据存储器：2KB RAM
- I/O 口：32 个
- 定时器：4 个（T0-T3）
- 串口：2 个
- ADC：8 路 10 位（本项目使用外部 PCF8591）
- 工作电压：5V / 3.3V

---

## 引脚定义

### P0 口（数据总线）

| 引脚 | 功能 | 说明 |
|------|------|------|
| P0.0-P0.7 | 数据总线 | 复用为数码管段码/LED数据/蜂鸣器继电器控制 |

**配置：**
- 准双向 I/O 模式
- 需外接上拉电阻（硬件已集成）

---

### P2 口（地址/控制总线）

| 引脚 | 功能 | 说明 |
|------|------|------|
| P2.0 | I2C_SCL | PCF8591 时钟线 |
| P2.1 | I2C_SDA | PCF8591 数据线 |
| P2.5-P2.7 | 地址线 | 外设片选信号（Y4C-Y7C） |

**片选地址：**

| 地址 | 外设 | 说明 |
|------|------|------|
| 0x80 | LED 控制器 | Y4C（100） |
| 0xA0 | 蜂鸣器/继电器 | Y5C（101） |
| 0xC0 | 数码管位选 | Y6C（110） |
| 0xE0 | 数码管段选 | Y7C（111） |

**控制逻辑：**
```c
// 选中外设
P2 = (P2 & 0x1F) | 地址;  // 保留低5位，设置高3位

// 锁存数据
P2 &= 0x1F;  // 清除片选信号
```

---

### P3 口（按键列线）

| 引脚 | 功能 | 说明 |
|------|------|------|
| P3.0 | KEY_COL4 | 矩阵键盘列4 |
| P3.1 | KEY_COL3 | 矩阵键盘列3 |
| P3.2 | KEY_COL2 | 矩阵键盘列2 |
| P3.3 | KEY_COL1 | 矩阵键盘列1 |

---

### P4 口（按键行线）

| 引脚 | 功能 | 说明 |
|------|------|------|
| P3.4 | KEY_ROW4 | 矩阵键盘行4 |
| P3.5 | KEY_ROW3 | 矩阵键盘行3 |
| P4.2 | KEY_ROW2 | 矩阵键盘行2 |
| P4.4 | KEY_ROW1 | 矩阵键盘行1 |

---

## 外设接口

### 1. PCF8591 AD/DA 芯片

#### 硬件连接

| PCF8591 引脚 | STC15 引脚 | 功能 |
|-------------|-----------|------|
| SCL | P2.0 | I2C 时钟线 |
| SDA | P2.1 | I2C 数据线 |
| VCC | 5V | 电源正 |
| GND | GND | 电源负 |
| VREF | 5V | 参考电压 |
| AIN0 | - | 模拟输入0 |
| AIN1 | - | 模拟输入1 |
| AIN2 | - | 模拟输入2 |
| AIN3 | 外部信号 | 模拟输入3（本项目使用） |
| AOUT | 外部负载 | 模拟输出 |

#### 芯片配置

**I2C 地址：**
- 写地址：`0x90` (1001 0000)
- 读地址：`0x91` (1001 0001)

**控制字节格式：**
```
+---+---+---+---+---+---+---+---+
| 0 | D | A | 0 | C1| C0| AE| AO|
+---+---+---+---+---+---+---+---+
  7   6   5   4   3   2   1   0
```

- **D**：DAC 使能位（0=禁用，1=使能）
- **A**：模拟输出使能（0=AOUT 输出 DAC，1=无）
- **C1-C0**：通道选择
  - 00：AIN0
  - 01：AIN1
  - 10：AIN2
  - 11：AIN3
- **AE**：自动增量使能
- **AO**：模拟输出设置

**本项目配置：**
- ADC 读取 AIN3：控制字节 = `0x43` (0100 0011)
- DAC 输出：通道地址 = `0x41` (0100 0001)

#### 电气特性

| 参数 | 数值 | 单位 |
|------|------|------|
| 分辨率 | 8 | bit |
| 参考电压 | 5.0 | V |
| ADC 量化步长 | 19.6 | mV |
| DAC 建立时间 | 10 | μs |
| I2C 时钟频率 | 100 | kHz |
| 输入阻抗 | > 1 | MΩ |
| 输出阻抗 | < 1 | kΩ |

---

### 2. LED 模块

#### 硬件电路

```
P0.x --[U1:74HC573]-- [限流电阻330Ω] -- LED -- GND
          ↑
       P2(Y4C)
```

**控制逻辑：**
- 74HC573 锁存器锁存 P0 数据
- LED 低电平点亮（共阳极接法）
- 驱动电流：约 15mA

#### 控制时序

```c
// 1. 准备数据
P0 = ~led_data;  // 取反（低电平点亮）

// 2. 锁存使能
P2 = (P2 & 0x1F) | 0x80;  // Y4C 使能

// 3. 锁存数据
P2 &= 0x1F;  // LE 下降沿锁存
```

---

### 3. 数码管模块

#### 硬件电路

**段码锁存器：**
```
P0 --[U3:74HC573]-- 段驱动 -- 数码管段
         ↑
      P2(Y7C)
```

**位选锁存器：**
```
P0 --[U2:74HC573]-- [三极管驱动] -- 数码管位
         ↑
      P2(Y6C)
```

#### 动态扫描原理

**时序图：**
```
时刻0    时刻1    时刻2    ...    时刻7
位0亮    位1亮    位2亮           位7亮
显示0    显示1    显示2           显示7
 ↓       ↓       ↓               ↓
<-------- 1ms 周期循环 -------->
```

**扫描频率：**
- 单位扫描周期：1ms
- 完整扫描周期：8ms
- 刷新频率：125Hz（高于人眼暂留频率 50Hz）

#### 段码表

**共阴极数码管段码：**

```
     a
    ---
 f |   | b
    -g-
 e |   | c
    ---  . dp
     d

段位：dp g f e d c b a
```

| 字符 | 段码 (Hex) | 二进制 |
|------|-----------|--------|
| 0 | 0xC0 | 1100 0000 |
| 1 | 0xF9 | 1111 1001 |
| 2 | 0xA4 | 1010 0100 |
| 3 | 0xB0 | 1011 0000 |
| 4 | 0x99 | 1001 1001 |
| 5 | 0x92 | 1001 0010 |
| 6 | 0x82 | 1000 0010 |
| 7 | 0xF8 | 1111 1000 |
| 8 | 0x80 | 1000 0000 |
| 9 | 0x90 | 1001 0000 |
| 熄灭 | 0xFF | 1111 1111 |
| U | 0xC1 | 1100 0001 |
| F | 0x8E | 1000 1110 |

**小数点控制：**
```c
P0 &= 0x7F;  // 清除 bit7，点亮小数点
```

---

### 4. 矩阵键盘

#### 硬件电路

```
      COL1  COL2  COL3  COL4
       ↓     ↓     ↓     ↓
ROW1 - S4 -- S5 -- S6 -- S7
ROW2 - S8 -- S9 -- S10 - S11
ROW3 - S12 - S13 - S14 - S15
ROW4 - S16 - S17 - S18 - S19
 ↓
输出
```

#### 扫描时序

**步骤：**
1. 行线全部置高电平
2. 选中行线 X 拉低
3. 读取列线状态
4. 根据行列组合确定按键
5. 切换到下一行

**时序图：**
```
ROW1: ‾\_____/‾‾‾‾‾‾‾‾‾‾‾‾
ROW2: ‾‾‾‾‾‾\_____/‾‾‾‾‾‾
COL1: ‾‾‾\_____/‾‾‾‾‾‾‾‾  (检测到 S4 按下)
```

**消抖处理：**
- 硬件消抖：每个按键并联 0.1μF 电容
- 软件消抖：10ms 扫描周期 + 边沿检测

---

### 5. 蜂鸣器与继电器

#### 硬件电路

**蜂鸣器：**
```
P0.6 --[U4:74HC573]-- [三极管] -- 蜂鸣器 -- VCC
                          ↓
                         GND
```

**继电器：**
```
P0.4 --[U4:74HC573]-- [三极管] -- 继电器线圈 -- VCC
                          ↓              ↑
                         GND        续流二极管
```

#### 控制逻辑

```c
// 控制蜂鸣器
P0 = 0x40;  // Bit6 = 1
P2 = (P2 & 0x1F) | 0xA0;  // Y5C 使能
P2 &= 0x1F;  // 锁存

// 控制继电器
P0 = 0x10;  // Bit4 = 1
P2 = (P2 & 0x1F) | 0xA0;  // Y5C 使能
P2 &= 0x1F;  // 锁存
```

---

## 电路原理

### 地址译码电路

**74HC138 三八译码器：**

```
P2.7 --[A2]
P2.6 --[A1]  74HC138  [Y0-Y7]-- 外设片选
P2.5 --[A0]
```

**真值表：**

| A2 | A1 | A0 | 选中输出 | 地址 | 外设 |
|----|----|----|---------:|------|------|
| 0  | 0  | 0  | Y0      | 0x00 | - |
| 0  | 0  | 1  | Y1      | 0x20 | - |
| 0  | 1  | 0  | Y2      | 0x40 | - |
| 0  | 1  | 1  | Y3      | 0x60 | - |
| 1  | 0  | 0  | Y4      | 0x80 | LED |
| 1  | 0  | 1  | Y5      | 0xA0 | 蜂鸣器/继电器 |
| 1  | 1  | 0  | Y6      | 0xC0 | 数码管位选 |
| 1  | 1  | 1  | Y7      | 0xE0 | 数码管段选 |

---

### 锁存器工作原理

**74HC573 八路锁存器：**

```
          +---[74HC573]---+
P0.0-P0.7 |D0-D7    Q0-Q7 | --> 输出
          |               |
P2.x -----|LE             | 锁存使能（低电平有效）
          |               |
    +-----|OE             | 输出使能（接地）
    |     +---------------+
   GND
```

**时序：**
```
LE:   ‾‾‾‾‾\___/‾‾‾‾‾
          ↑   ↑
      锁存  输出
```

---

## 时序分析

### I2C 总线时序

#### 启动信号（START）

```
SDA: ‾‾‾‾‾\________
SCL: ‾‾‾‾‾‾‾‾‾‾‾‾‾‾
     <-T1->
```

- T1 = 5μs（DELAY_TIME）

#### 停止信号（STOP）

```
SDA: _______/‾‾‾‾‾‾
SCL: _____/‾‾‾‾‾‾‾‾
     <-T1->
```

#### 数据传输

```
SDA: --D7--D6--D5--D4--D3--D2--D1--D0--
SCL: _/‾\_/‾\_/‾\_/‾\_/‾\_/‾\_/‾\_/‾\_
     <---T1--->
```

- 数据在 SCL 高电平期间稳定
- SDA 在 SCL 低电平期间可变

#### 完整读取时序

```
START | 0x90 | ACK | 0x43 | ACK | START | 0x91 | ACK | DATA | NACK | STOP
  ↓      ↓      ↓     ↓      ↓      ↓       ↓      ↓     ↓      ↓      ↓
主机  主机发送 从机 主机发送 从机  主机   主机发送 从机  从机  主机   主机
启动  设备地址 应答 通道地址 应答  重启   读地址  应答  发送  不应答 停止
```

---

### 数码管扫描时序

```
时间轴: 0ms    1ms    2ms    3ms    4ms    5ms    6ms    7ms    8ms
        ↓      ↓      ↓      ↓      ↓      ↓      ↓      ↓      ↓
位选:   位0    位1    位2    位3    位4    位5    位6    位7    位0
显示:   U      空     空     空     空     2.     0      0      U
```

**单次扫描流程：**
```
1. 消影 (P0=0xFF, P2=0xE0)      50μs
2. 位选 (P0=wela, P2=0xC0)      50μs
3. 段选 (P0=dula, P2=0xE0)      900μs
   总计: 1ms
```

---

### 按键扫描时序

```
定时器中断周期: 1ms
按键扫描周期: 10ms (减速计数)

时间轴: 0ms    10ms   20ms   30ms
        ↓      ↓      ↓      ↓
扫描:   读取   读取   读取   读取
        ↓      ↓      ↓      ↓
检测:   按下   保持   保持   抬起
        ↓                    ↓
事件:   Key_Down            Key_Up
```

---

## 📊 电气参数

### 电源要求

| 参数 | 最小值 | 典型值 | 最大值 | 单位 |
|------|--------|--------|--------|------|
| VCC | 4.5 | 5.0 | 5.5 | V |
| 工作电流 | - | 150 | 300 | mA |
| 待机电流 | - | 50 | - | mA |

### 时序参数

| 参数 | 数值 | 单位 |
|------|------|------|
| 系统时钟 | 12 | MHz |
| 定时器周期 | 1 | ms |
| 数码管扫描周期 | 8 | ms |
| 按键扫描周期 | 10 | ms |
| AD 采样周期 | 500 | ms |
| I2C 时钟频率 | 100 | kHz |

---

## 🔧 调试接口

### UART 串口（预留）

| 引脚 | 功能 | 说明 |
|------|------|------|
| P3.0 | RXD | 接收数据 |
| P3.1 | TXD | 发送数据 |

**配置：**
- 波特率：115200
- 数据位：8
- 停止位：1
- 校验：无

---

## ⚠️ 硬件注意事项

### 1. 电源设计
- 使用稳压芯片（如 7805）提供稳定 5V 电源
- 在 VCC 和 GND 之间并联 100μF 电解电容 + 0.1μF 瓷片电容

### 2. I2C 总线
- SDA 和 SCL 需上拉电阻（4.7kΩ）
- 总线长度不超过 1 米
- 避免与强干扰源并行走线

### 3. 数码管驱动
- 限流电阻根据 LED 亮度调整（推荐 330Ω-1kΩ）
- 共阴极和共阳极数码管段码不同，注意区分

### 4. 继电器驱动
- 必须有续流二极管保护（如 1N4007）
- 三极管驱动电流需大于继电器吸合电流

---

**文档版本：** v1.0
**最后更新：** 2026-02-04
