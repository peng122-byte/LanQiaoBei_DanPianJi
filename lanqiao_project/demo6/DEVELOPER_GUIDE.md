# æ¸©åº¦ç›‘æ§ç³»ç»Ÿå¼€å‘è€…æŒ‡å—

## ğŸ“– æ–‡æ¡£è¯´æ˜

æœ¬æ–‡æ¡£æä¾›å®Œæ•´çš„ä»£ç å®ç°ç»†èŠ‚ã€ç®—æ³•è§£æå’Œä¼˜åŒ–æ–¹æ¡ˆï¼Œé€‚åˆéœ€è¦æ·±å…¥ç†è§£ç³»ç»Ÿæ¶æ„çš„å¼€å‘è€…ã€‚

---

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
demo6/
â”œâ”€â”€ User/
â”‚   â”œâ”€â”€ main.c              # ä¸»ç¨‹åºæ–‡ä»¶
â”‚   â”œâ”€â”€ Init.h              # ç³»ç»Ÿåˆå§‹åŒ–å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ Led.h               # LED é©±åŠ¨å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ Key.h               # æŒ‰é”®é©±åŠ¨å¤´æ–‡ä»¶
â”‚   â”œâ”€â”€ Seg.h               # æ•°ç ç®¡é©±åŠ¨å¤´æ–‡ä»¶
â”‚   â””â”€â”€ onewire.h           # DS18B20 å•æ€»çº¿é©±åŠ¨
â”œâ”€â”€ Libraries/              # åº•å±‚åº“æ–‡ä»¶
â””â”€â”€ Objects/                # ç¼–è¯‘è¾“å‡ºç›®å½•
```

---

## ğŸ“‹ å®Œæ•´æºç åˆ†æ

### 1. å¤´æ–‡ä»¶å£°æ˜

```c
/* å¤´æ–‡ä»¶å£°æ˜åŒº */
#include <STC15F2K60S2.H>   // å•ç‰‡æœºå¯„å­˜å™¨å®šä¹‰
#include <Init.h>            // ç³»ç»Ÿåˆå§‹åŒ–ï¼šæ—¶é’Ÿã€ç«¯å£é…ç½®
#include <Led.h>             // LED é©±åŠ¨ï¼šLed_Disp(pos, data)
#include <Key.h>             // æŒ‰é”®é©±åŠ¨ï¼šKey_Read() è¿”å›é”®å€¼
#include <Seg.h>             // æ•°ç ç®¡é©±åŠ¨ï¼šSeg_Disp(pos, seg, point)
#include "onewire.h"         // DS18B20ï¼šread_t() è¿”å›æ¸©åº¦æµ®ç‚¹æ•°
```

**æ¨¡å—ä¾èµ–å…³ç³»**:
```
main.c
  â”œâ”€â”€ Init.h (ç³»ç»Ÿé…ç½®)
  â”œâ”€â”€ onewire.h (æ¸©åº¦é‡‡é›†)
  â””â”€â”€ è¾“å‡ºæ¨¡å—
      â”œâ”€â”€ Led.h (çŠ¶æ€æŒ‡ç¤º)
      â””â”€â”€ Seg.h (æ•°æ®æ˜¾ç¤º)
  â””â”€â”€ è¾“å…¥æ¨¡å—
      â””â”€â”€ Key.h (ç”¨æˆ·äº¤äº’)
```

---

### 2. å…¨å±€å˜é‡å®šä¹‰

#### æŒ‰é”®ç›¸å…³å˜é‡

```c
/* æŒ‰é”®çŠ¶æ€æœºå˜é‡ */
unsigned char Key_Val;        // å½“å‰æŒ‰é”®å€¼ (å®æ—¶è¯»å–)
unsigned char Key_Down;       // æŒ‰é”®ä¸‹é™æ²¿æ ‡å¿— (æŒ‰ä¸‹ç¬é—´ä¸º1)
unsigned char Key_Old;        // ä¸Šæ¬¡æŒ‰é”®å€¼ (ç”¨äºè¾¹æ²¿æ£€æµ‹)
unsigned char Key_Up;         // æŒ‰é”®ä¸Šå‡æ²¿æ ‡å¿— (é‡Šæ”¾ç¬é—´ä¸º1)
unsigned char Key_Slow_Down;  // æŒ‰é”®æ‰«æå‡é€Ÿè®¡æ•°å™¨ (0-9å¾ªç¯)
unsigned int Key_Long;        // é•¿æŒ‰æ—¶é—´è®¡æ•°å™¨ (ms)
unsigned int Delay100ms;      // å¿«é€Ÿé‡å¤å»¶æ—¶è®¡æ•°å™¨
```

**å˜é‡ä½¿ç”¨ç¤ºä¾‹**:
```c
// è¾¹æ²¿æ£€æµ‹ç®—æ³•
Key_Val = Key_Read();                         // è¯»å–å½“å‰çŠ¶æ€ (0=æŒ‰ä¸‹, é0=é‡Šæ”¾)
Key_Down = Key_Val & (Key_Old ^ Key_Val);     // æ•è·æŒ‰ä¸‹ç¬é—´
Key_Up = ~Key_Val & (Key_Old ^ Key_Val);      // æ•è·é‡Šæ”¾ç¬é—´
Key_Old = Key_Val;                            // æ›´æ–°å†å²çŠ¶æ€

// ç¤ºä¾‹ï¼šæ£€æµ‹ S4 æŒ‰ä¸‹
if (Key_Down == 12) {
    // S4 æŒ‰ä¸‹æ—¶æ‰§è¡Œçš„æ“ä½œ
}
```

#### æ•°ç ç®¡ç›¸å…³å˜é‡

```c
/* æ•°ç ç®¡æ˜¾ç¤ºç¼“å†²åŒº */
unsigned char Seg_Buf[8] = {10,10,10,10,10,10,10,10};  // æ®µç ç¼“å†²åŒº
                                                        // 10=ç©ºç™½, 11=C, 12=P, 13=-
unsigned char Seg_Point[8] = {0,0,0,0,0,0,0,0};       // å°æ•°ç‚¹æ ‡å¿— (1=æ˜¾ç¤º)
unsigned char Seg_Pos;                                 // å½“å‰æ‰«æä½ç½® (0-7)
unsigned int Seg_Slow_Down;                            // åˆ·æ–°å‡é€Ÿè®¡æ•°å™¨
```

**æ•°ç ç®¡ç¼–ç è¡¨**:
```c
// æ•°å­— 0-9 å¯¹åº”æ®µç ç´¢å¼• 0-9
// ç‰¹æ®Šå­—ç¬¦æ˜ å°„ï¼š
// 10 -> ç©ºç™½ (å…¨ç­)
// 11 -> 'C'  (æ¸©åº¦æ¨¡å¼æ ‡è¯†)
// 12 -> 'P'  (å‚æ•°æ¨¡å¼æ ‡è¯†)
// 13 -> '-'  (åˆ†éš”ç¬¦)
```

#### LED ç›¸å…³å˜é‡

```c
/* LED çŠ¶æ€æ§åˆ¶ */
unsigned char ucLed[8] = {0,0,0,0,0,0,0,0};  // LED çŠ¶æ€æ•°ç»„ (1=äº®, 0=ç­)
unsigned char Led_Pwm;                        // PWM è®¡æ•°å™¨ (0-12)
unsigned char Led_Level;                      // PWM å ç©ºæ¯”ç­‰çº§ (3/6/9)
```

**PWM å®ç°åŸç†**:
```c
// åœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­æ¯ 1ms æ‰§è¡Œï¼š
if (++Led_Pwm == 12) Led_Pwm = 0;     // 12ms å‘¨æœŸ
if (Led_Pwm < Led_Level)              // æ¯”è¾ƒäº§ç”Ÿ PWM
    Led_Disp(Seg_Pos, ucLed[Seg_Pos]); // äº®
else
    Led_Disp(Seg_Pos, 0);              // ç­

// å ç©ºæ¯”è®¡ç®—ï¼š
// Led_Level = 3  -> 3/12 = 25%
// Led_Level = 6  -> 6/12 = 50%
// Led_Level = 9  -> 9/12 = 75%
```

#### ä¸šåŠ¡é€»è¾‘å˜é‡

```c
/* æ¸©åº¦ç›‘æ§é€»è¾‘ */
float t;                              // å½“å‰æ¸©åº¦å€¼ (æµ®ç‚¹æ•°)
unsigned char TMAX = 30;              // æœ€å¤§æ¸©åº¦é˜ˆå€¼
unsigned char TMIN = 20;              // æœ€å°æ¸©åº¦é˜ˆå€¼

/* ç•Œé¢çŠ¶æ€ */
unsigned char Display_Mode;           // æ˜¾ç¤ºæ¨¡å¼ (0=æ¸©åº¦, 1=å‚æ•°)
bit Mode1_Flag;                       // å‚æ•°æ¨¡å¼é—ªçƒæ ‡å¿— (250ms ç¿»è½¬)
unsigned int Tick;                    // é—ªçƒè®¡æ—¶å™¨

/* å‚æ•°è®¾ç½® */
unsigned char Set_Index;              // è®¾ç½®é¡¹ç´¢å¼• (0=TMAX, 1=TMIN)
unsigned char P_DIS[2] = {30,20};     // å‚æ•°æ˜¾ç¤ºç¼“å­˜ [TMAX, TMIN]
unsigned char Error;                  // å‚æ•°é”™è¯¯æ ‡å¿—
```

---

### 3. æŒ‰é”®å¤„ç†å‡½æ•°è¯¦è§£

#### 3.1 æŒ‰é”®æ‰«æç®—æ³•

```c
void Key_Proc()
{
    // ========== å‡é€Ÿæ§åˆ¶ ==========
    if (Key_Slow_Down) return;  // é 0 æ—¶è·³è¿‡ï¼Œç­‰å¾…è®¡æ•°å™¨å½’é›¶
    Key_Slow_Down = 1;          // è®¾ç½®ä¸º 1ï¼Œåœ¨ä¸­æ–­ä¸­é€’å‡è‡³ 0
    // å®é™…æ‰«æå‘¨æœŸï¼š10ms (ä¸­æ–­ä¸­æ¯ 1ms å‡ 1)

    // ========== è¾¹æ²¿æ£€æµ‹ ==========
    Key_Val = Key_Read();       // è¯»å–å½“å‰æŒ‰é”®çŠ¶æ€

    // ä¸‹é™æ²¿æ£€æµ‹ (æŒ‰ä¸‹ç¬é—´)
    // åŸç†ï¼šå½“å‰ä¸º 0 ä¸”ä¸Šæ¬¡ä¸º 1 æ—¶ï¼Œå¼‚æˆ–ä¸º 1ï¼Œä¸ 0 å¾— 0
    //      å½“å‰ä¸º 0 ä¸”ä¸Šæ¬¡ä¸º 0 æ—¶ï¼Œå¼‚æˆ–ä¸º 0ï¼Œä¸ 0 å¾— 0
    //      å½“å‰ä¸º 1 ä¸”ä¸Šæ¬¡ä¸º 0 æ—¶ï¼Œå¼‚æˆ–ä¸º 1ï¼Œä¸ 1 å¾— 1 âœ“
    Key_Down = Key_Val & (Key_Old ^ Key_Val);

    // ä¸Šå‡æ²¿æ£€æµ‹ (é‡Šæ”¾ç¬é—´)
    Key_Up = ~Key_Val & (Key_Old ^ Key_Val);

    Key_Old = Key_Val;          // ä¿å­˜å½“å‰çŠ¶æ€ä¾›ä¸‹æ¬¡æ¯”è¾ƒ

    // ========== æŒ‰é”®äº‹ä»¶å¤„ç† ==========
    switch (Key_Down)
    {
        // ... æŒ‰é”®å¤„ç†é€»è¾‘
    }
}
```

**è¾¹æ²¿æ£€æµ‹çœŸå€¼è¡¨**:

| Key_Old | Key_Val | Key_Old ^ Key_Val | Key_Val & (å¼‚æˆ–) | å«ä¹‰ |
|---------|---------|-------------------|-----------------|------|
| 0 (æŒ‰ä¸‹) | 0 (æŒ‰ä¸‹) | 0 | 0 | æŒç»­æŒ‰ä¸‹ |
| 0 (æŒ‰ä¸‹) | é0 (é‡Šæ”¾) | é0 | 0 | é‡Šæ”¾ |
| é0 (é‡Šæ”¾) | 0 (æŒ‰ä¸‹) | é0 | é0 | **æŒ‰ä¸‹ç¬é—´** âœ“ |
| é0 (é‡Šæ”¾) | é0 (é‡Šæ”¾) | 0 | 0 | æŒç»­é‡Šæ”¾ |

#### 3.2 S4 æŒ‰é”®å¤„ç† (æ¨¡å¼åˆ‡æ¢/ä¿å­˜)

```c
case 12:  // S4 æŒ‰é”®
    Display_Mode++;
    if (Display_Mode == 2)  // ä»å‚æ•°æ¨¡å¼é€€å‡º
    {
        // ========== å‚æ•°éªŒè¯ ==========
        if (P_DIS[0] > P_DIS[1])  // TMAX > TMIN åˆæ³•
        {
            TMAX = P_DIS[0];      // ä¿å­˜è®¾ç½®
            TMIN = P_DIS[1];
            Display_Mode = 0;     // è¿”å›æ¸©åº¦æ˜¾ç¤ºæ¨¡å¼
            Error = 0;            // æ¸…é™¤é”™è¯¯æ ‡å¿—
        }
        else  // å‚æ•°éæ³•
        {
            Display_Mode = 0;     // è¿”å›æ¸©åº¦æ˜¾ç¤ºæ¨¡å¼
            P_DIS[0] = 30;        // æ¢å¤é»˜è®¤å€¼
            P_DIS[1] = 20;
            TMAX = 30;
            TMIN = 20;
            Error = 1;            // è®¾ç½®é”™è¯¯æ ‡å¿— (LED4 ç‚¹äº®)
        }
    }
    break;
```

**çŠ¶æ€è½¬æ¢å›¾**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    S4     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    S4 (åˆæ³•)    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¸©åº¦æ˜¾ç¤ºæ¨¡å¼ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ å‚æ•°è®¾ç½®æ¨¡å¼ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚ æ¸©åº¦æ˜¾ç¤ºæ¨¡å¼ â”‚
â”‚ Mode = 0    â”‚           â”‚ Mode = 1    â”‚                 â”‚ Mode = 0    â”‚
â”‚ Error = 0   â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ (é—ªçƒç¼–è¾‘)  â”‚ <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ Error = 0   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   S4 (éæ³•)     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                             æ¢å¤é»˜è®¤å€¼
                                             Error = 1
```

#### 3.3 S5 æŒ‰é”®å¤„ç† (åˆ‡æ¢è®¾ç½®é¡¹)

```c
case 13:  // S5 æŒ‰é”®
    if (Display_Mode == 1)  // ä»…åœ¨å‚æ•°è®¾ç½®æ¨¡å¼æœ‰æ•ˆ
    {
        Set_Index++;
        if (Set_Index == 2) Set_Index = 0;  // 0 â†” 1 å¾ªç¯åˆ‡æ¢
    }
    break;
```

**è®¾ç½®é¡¹å¾ªç¯**:
```
Set_Index = 0 (TMAX) â”€â”€S5â”€â”€> Set_Index = 1 (TMIN)
         ^                              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€S5â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.4 S6/S7 æŒ‰é”®å¤„ç† (è°ƒèŠ‚æ•°å€¼)

```c
case 14:  // S6 åŠ 
    if (Display_Mode == 1)
    {
        switch (Set_Index)
        {
            case 0:  // è°ƒèŠ‚ TMAX
                P_DIS[0]++;
                if (P_DIS[0] >= 70) P_DIS[0] = 70;  // ä¸Šé™æˆªæ–­
                break;
            case 1:  // è°ƒèŠ‚ TMIN
                P_DIS[1]++;
                if (P_DIS[1] >= 70) P_DIS[1] = 70;
                break;
        }
    }
    break;

case 15:  // S7 å‡
    if (Display_Mode == 1)
    {
        switch (Set_Index)
        {
            case 0:
                P_DIS[0]--;
                if (P_DIS[0] <= 10) P_DIS[0] = 10;  // ä¸‹é™æˆªæ–­
                break;
            case 1:
                P_DIS[1]--;
                if (P_DIS[1] <= 10) P_DIS[1] = 10;
                break;
        }
    }
    break;
```

#### 3.5 é•¿æŒ‰å¿«é€Ÿè°ƒèŠ‚

```c
// åœ¨æŒ‰é”®å¤„ç†å‡½æ•°ä¸­ç›‘å¬æŒç»­æŒ‰ä¸‹çŠ¶æ€
switch (Key_Old)  // æ³¨æ„ï¼šè¿™é‡Œæ£€æµ‹çš„æ˜¯æŒç»­çŠ¶æ€ï¼Œä¸æ˜¯è¾¹æ²¿
{
    case 14:  // S6 æŒç»­æŒ‰ä¸‹
        if (Key_Long >= 250)  // é•¿æŒ‰ 250ms åè§¦å‘
        {
            if (++Delay100ms >= 5)  // æ¯ 50ms è§¦å‘ä¸€æ¬¡
            {
                Delay100ms = 0;
                if (Display_Mode == 1)
                {
                    switch (Set_Index)
                    {
                        case 0:
                            P_DIS[0]++;
                            if (P_DIS[0] >= 70) P_DIS[0] = 70;
                            break;
                        case 1:
                            P_DIS[1]++;
                            if (P_DIS[1] >= 70) P_DIS[1] = 70;
                            break;
                    }
                }
            }
        }
        break;

    case 15:  // S7 æŒç»­æŒ‰ä¸‹ (åŒä¸Š)
        // ... ç±»ä¼¼é€»è¾‘
        break;
}
```

**é•¿æŒ‰æ—¶åºå›¾**:
```
æŒ‰é”®æŒ‰ä¸‹                250ms              300ms              350ms
   â”‚                     â”‚                  â”‚                  â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚   Key_Long é€’å¢     â”‚  è§¦å‘å¿«é€Ÿæ¨¡å¼    â”‚  å†æ¬¡è§¦å‘         â”‚
   â”‚   0 -> 250          â”‚  æ‰§è¡Œä¸€æ¬¡æ“ä½œ    â”‚  æ‰§è¡Œä¸€æ¬¡æ“ä½œ     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         ^                  ^                  ^
                      é•¿æŒ‰è§¦å‘          50ms é—´éš”          50ms é—´éš”
```

#### 3.6 S8 æŒ‰é”®å¤„ç† (æ¢å¤é»˜è®¤)

```c
case 16:  // S8 æŒ‰é”®
    TMIN = 20;
    TMAX = 30;
    P_DIS[0] = 30;
    P_DIS[1] = 20;
    Display_Mode = 0;  // è¿”å›æ¸©åº¦æ˜¾ç¤ºæ¨¡å¼
    break;
```

---

### 4. æ˜¾ç¤ºå¤„ç†å‡½æ•°è¯¦è§£

#### 4.1 æ¸©åº¦æ•°æ®é‡‡é›†

```c
void Seg_Proc()
{
    // ========== å‡é€Ÿæ§åˆ¶ ==========
    if (Seg_Slow_Down) return;
    Seg_Slow_Down = 1;  // 50ms å‘¨æœŸ (ä¸­æ–­ä¸­é€’å‡)

    // ========== æ¸©åº¦é‡‡é›† ==========
    t = read_t();  // è°ƒç”¨ DS18B20 é©±åŠ¨è¯»å–æ¸©åº¦
    // è¿”å›å€¼ç¤ºä¾‹ï¼š25.6Â°C -> t = 25.6 (float)

    // ========== æ˜¾ç¤ºå†…å®¹ç”Ÿæˆ ==========
    switch (Display_Mode)
    {
        case 0:  // æ¸©åº¦æ˜¾ç¤ºæ¨¡å¼
            // ... è§ä¸‹æ–‡
            break;

        case 1:  // å‚æ•°è®¾ç½®æ¨¡å¼
            // ... è§ä¸‹æ–‡
            break;
    }
}
```

#### 4.2 æ¸©åº¦æ˜¾ç¤ºæ¨¡å¼

```c
case 0:  // æ¸©åº¦æ˜¾ç¤ºæ¨¡å¼
    // æ˜¾ç¤ºæ ¼å¼: C  XX.XÂ°
    // ä½ç½®:     0  1234567

    Seg_Buf[0] = 11;  // 'C' å­—ç¬¦
    Seg_Buf[1] = 10;  // ç©ºç™½
    Seg_Buf[2] = 10;  // ç©ºç™½
    Seg_Buf[3] = 10;  // ç©ºç™½

    // ========== æ¸©åº¦æ•´æ•°éƒ¨åˆ† ==========
    // ç¤ºä¾‹ï¼št = 25.6
    Seg_Buf[4] = (unsigned char)t / 10 % 10;  // 2 (åä½)
    Seg_Buf[5] = (unsigned char)t % 10;       // 5 (ä¸ªä½)

    // ========== å°æ•°ç‚¹ ==========
    Seg_Point[5] = 1;  // åœ¨ä¸ªä½åæ˜¾ç¤ºå°æ•°ç‚¹

    // ========== æ¸©åº¦å°æ•°éƒ¨åˆ† ==========
    // åŸç†ï¼š25.6 * 10 = 256ï¼Œå– 256 % 10 = 6
    Seg_Buf[6] = (unsigned int)(t * 10) % 10;  // 6 (å°æ•°ç¬¬ä¸€ä½)

    Seg_Buf[7] = 11;  // 'Â°' ç¬¦å· (å¤ç”¨ 'C' ç ï¼Œæ˜¾ç¤ºæ•ˆæœç•¥ä¸åŒ)
    break;
```

**æ¸©åº¦è½¬æ¢ç¤ºä¾‹**:

| æ¸©åº¦ (t) | (int)t | t/10%10 | t%10 | (t*10)%10 | æ˜¾ç¤ºç»“æœ |
|----------|--------|---------|------|-----------|----------|
| 23.4     | 23     | 2       | 3    | 4         | C  23.4Â° |
| 8.7      | 8      | 0       | 8    | 7         | C  08.7Â° |
| 56.2     | 56     | 5       | 6    | 2         | C  56.2Â° |

#### 4.3 å‚æ•°è®¾ç½®æ¨¡å¼

```c
case 1:  // å‚æ•°è®¾ç½®æ¨¡å¼
    // æ˜¾ç¤ºæ ¼å¼: P  XX-XX
    // ä½ç½®:     0  12 3456 7

    Seg_Buf[0] = 12;   // 'P' å­—ç¬¦
    Seg_Buf[1] = 10;   // ç©ºç™½
    Seg_Buf[2] = 10;   // ç©ºç™½

    // ========== TMAX æ˜¾ç¤º ==========
    Seg_Buf[3] = P_DIS[0] / 10;  // TMAX åä½
    Seg_Buf[4] = P_DIS[0] % 10;  // TMAX ä¸ªä½

    // ========== åˆ†éš”ç¬¦ ==========
    Seg_Buf[5] = 13;   // '-' å­—ç¬¦
    Seg_Point[5] = 0;  // å…³é—­å°æ•°ç‚¹

    // ========== TMIN æ˜¾ç¤º ==========
    Seg_Buf[6] = P_DIS[1] / 10;  // TMIN åä½
    Seg_Buf[7] = P_DIS[1] % 10;  // TMIN ä¸ªä½

    // ========== é—ªçƒæ§åˆ¶ ==========
    if (Mode1_Flag)  // æ¯ 250ms ç¿»è½¬ä¸€æ¬¡
    {
        if (Set_Index == 0)  // æ­£åœ¨ç¼–è¾‘ TMAX
        {
            Seg_Buf[3] = 10;  // éšè— TMAX åä½
            Seg_Buf[4] = 10;  // éšè— TMAX ä¸ªä½
        }
        if (Set_Index == 1)  // æ­£åœ¨ç¼–è¾‘ TMIN
        {
            Seg_Buf[6] = 10;  // éšè— TMIN åä½
            Seg_Buf[7] = 10;  // éšè— TMIN ä¸ªä½
        }
    }
    break;
```

**é—ªçƒæ•ˆæœæ¼”ç¤º**:
```
æ—¶é—´è½´:  0ms      250ms     500ms     750ms
         â”‚         â”‚         â”‚         â”‚
æ˜¾ç¤º:    P  30-20  P    -20  P  30-20  P    -20  (Set_Index=0)
çŠ¶æ€:    æ˜¾ç¤ºå…¨éƒ¨   éšè—TMAX  æ˜¾ç¤ºå…¨éƒ¨   éšè—TMAX
```

---

### 5. LED æ§åˆ¶å‡½æ•°è¯¦è§£

```c
void Led_Proc()
{
    // ========== è¿‡çƒ­æ£€æµ‹ (T â‰¥ TMAX) ==========
    if ((unsigned char)t >= TMAX)
    {
        ucLed[0] = 1;      // LED1 ç‚¹äº®
        Led_Level = 3;     // è®¾ç½® PWM å ç©ºæ¯” 25%
    }
    else
    {
        ucLed[0] = 0;      // LED1 ç†„ç­
    }

    // ========== æ­£å¸¸èŒƒå›´ (TMIN â‰¤ T â‰¤ TMAX) ==========
    if ((TMIN <= (unsigned char)t) && (TMAX >= (unsigned char)t))
    {
        Led_Level = 6;     // è®¾ç½® PWM å ç©ºæ¯” 50%
        ucLed[1] = 1;      // LED2 ç‚¹äº®
    }
    else
    {
        ucLed[1] = 0;      // LED2 ç†„ç­
    }

    // ========== è¿‡å†·æ£€æµ‹ (T â‰¤ TMIN) ==========
    if ((unsigned char)t <= TMIN)
    {
        ucLed[2] = 1;      // LED3 ç‚¹äº®
        Led_Level = 9;     // è®¾ç½® PWM å ç©ºæ¯” 75%
    }
    else
    {
        ucLed[2] = 0;      // LED3 ç†„ç­
    }

    // ========== å‚æ•°é”™è¯¯æŒ‡ç¤º ==========
    if (Error)
        ucLed[3] = 1;      // LED4 ç‚¹äº® (å¸¸äº®ï¼Œæ—  PWM)
    else
        ucLed[3] = 0;      // LED4 ç†„ç­
}
```

**LED çŠ¶æ€ä¼˜å…ˆçº§è¡¨**:

| æ¸©åº¦èŒƒå›´ | LED1 | LED2 | LED3 | Led_Level | äº®åº¦ |
|---------|------|------|------|-----------|------|
| T < TMIN | ç­ | ç­ | äº® | 9 | 75% |
| T = TMIN | ç­ | äº® | äº® | 6 | 50% |
| TMIN < T < TMAX | ç­ | äº® | ç­ | 6 | 50% |
| T = TMAX | äº® | äº® | ç­ | 3 | 25% |
| T > TMAX | äº® | ç­ | ç­ | 3 | 25% |

**æ³¨æ„äº‹é¡¹**:
- LED2 å’Œ LED1/LED3 å¯èƒ½åŒæ—¶ç‚¹äº® (è¾¹ç•Œå€¼)
- Led_Level ä¼šè¢«åç»­åˆ¤æ–­è¦†ç›–,å®é™…ä»¥æœ€åä¸€æ¬¡èµ‹å€¼ä¸ºå‡†
- LED4 çŠ¶æ€ç‹¬ç«‹,ä¸å— PWM æ§åˆ¶

---

### 6. å®šæ—¶å™¨ä¸­æ–­å‡½æ•°è¯¦è§£

#### 6.1 å®šæ—¶å™¨åˆå§‹åŒ–

```c
void Timer0Init(void)  // 1æ¯«ç§’ @12.000MHz
{
    AUXR &= 0x7F;      // å®šæ—¶å™¨æ—¶é’Ÿ 12T æ¨¡å¼
    TMOD &= 0xF0;      // æ¸…é™¤ Timer0 æ¨¡å¼ä½
    TL0 = 0x18;        // è®¾ç½®åˆå€¼ä½ 8 ä½
    TH0 = 0xFC;        // è®¾ç½®åˆå€¼é«˜ 8 ä½
    TF0 = 0;           // æ¸…é™¤æº¢å‡ºæ ‡å¿—
    TR0 = 1;           // å¯åŠ¨ Timer0
    ET0 = 1;           // ä½¿èƒ½ Timer0 ä¸­æ–­
    EA = 1;            // ä½¿èƒ½å…¨å±€ä¸­æ–­
}
```

**å®šæ—¶è®¡ç®—**:
```
æ—¶é’Ÿé¢‘ç‡: 12MHz
åˆ†é¢‘ç³»æ•°: 12T æ¨¡å¼ (12 åˆ†é¢‘)
å®šæ—¶å™¨é¢‘ç‡: 12MHz / 12 = 1MHz
è®¡æ•°å‘¨æœŸ: 1/1MHz = 1Î¼s

ç›®æ ‡æ—¶é—´: 1ms = 1000Î¼s
éœ€è¦è®¡æ•°: 1000 æ¬¡
16 ä½æœ€å¤§å€¼: 65536
åˆå€¼: 65536 - 1000 = 64536 = 0xFC18

TH0 = 0xFC (é«˜å­—èŠ‚)
TL0 = 0x18 (ä½å­—èŠ‚)
```

#### 6.2 ä¸­æ–­æœåŠ¡å‡½æ•°

```c
void Timer0Server() interrupt 1
{
    // ========== å‡é€Ÿè®¡æ•°å™¨ç»´æŠ¤ (10ms å‘¨æœŸ) ==========
    if (++Key_Slow_Down == 10) Key_Slow_Down = 0;
    // ä½œç”¨ï¼šKey_Proc() ä¸­çš„ if(Key_Slow_Down) return; å®ç° 10ms æ‰§è¡Œä¸€æ¬¡

    // ========== å‡é€Ÿè®¡æ•°å™¨ç»´æŠ¤ (500ms å‘¨æœŸ) ==========
    if (++Seg_Slow_Down == 500) Seg_Slow_Down = 0;
    // ä½œç”¨ï¼šSeg_Proc() ä¸­çš„ if(Seg_Slow_Down) return; å®ç° 500ms æ‰§è¡Œä¸€æ¬¡

    // ========== æ•°ç ç®¡åŠ¨æ€æ‰«æ (2ms å‘¨æœŸ) ==========
    if (++Seg_Pos == 8) Seg_Pos = 0;  // ä½é€‰è®¡æ•°å™¨å¾ªç¯
    Seg_Disp(Seg_Pos, Seg_Buf[Seg_Pos], Seg_Point[Seg_Pos]);
    // æ¯ 1ms åˆ‡æ¢ä¸€ä½ï¼Œ8 ä½æ‰«æå®Œæˆéœ€ 8ms
    // åˆ·æ–°ç‡: 1000ms / 8ms = 125Hz (å®é™…æ˜¾ç¤ºé¢‘ç‡)

    // ========== å‚æ•°æ¨¡å¼é—ªçƒæ§åˆ¶ (250ms ç¿»è½¬) ==========
    if (Display_Mode == 1)
    {
        if (++Tick == 250)
        {
            Tick = 0;
            Mode1_Flag ^= 1;  // å¼‚æˆ–ç¿»è½¬ï¼š0->1, 1->0
        }
    }

    // ========== é•¿æŒ‰æ£€æµ‹è®¡æ•°å™¨ ==========
    if ((Key_Old == 14) || (Key_Old == 15))  // S6 æˆ– S7 æŒç»­æŒ‰ä¸‹
    {
        if (++Key_Long == 65535) Key_Long = 0;  // é˜²æ­¢æº¢å‡º
        // è¾¾åˆ° 250 æ—¶è§¦å‘é•¿æŒ‰é€»è¾‘ (åœ¨ Key_Proc ä¸­åˆ¤æ–­)
    }
    else
    {
        Key_Long = 0;  // æŒ‰é”®é‡Šæ”¾ç«‹å³æ¸…é›¶
    }

    // ========== LED PWM è¾“å‡º ==========
    if (++Led_Pwm == 12) Led_Pwm = 0;  // 12ms å‘¨æœŸè®¡æ•°å™¨
    if (Led_Pwm < Led_Level)
        Led_Disp(Seg_Pos, ucLed[Seg_Pos]);  // å ç©ºæ¯”å†…ç‚¹äº®
    else
        Led_Disp(Seg_Pos, 0);                // å ç©ºæ¯”å¤–ç†„ç­
    // PWM é¢‘ç‡: 1000ms / 12ms â‰ˆ 83.3Hz
}
```

**æ—¶åºå…³ç³»å›¾**:
```
æ—¶é—´è½´ (ms):  0    1    2    3    4    5    6    7    8    9   10
              â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
Key_Slow_Down: 1â”€â”€â”€â”€2â”€â”€â”€â”€3â”€â”€â”€â”€4â”€â”€â”€â”€5â”€â”€â”€â”€6â”€â”€â”€â”€7â”€â”€â”€â”€8â”€â”€â”€â”€9â”€â”€â”€â”€0 (è§¦å‘æ‰«æ)
Seg_Pos:      0â”€â”€â”€â”€1â”€â”€â”€â”€2â”€â”€â”€â”€3â”€â”€â”€â”€4â”€â”€â”€â”€5â”€â”€â”€â”€6â”€â”€â”€â”€7â”€â”€â”€â”€0â”€â”€â”€â”€1 (æ‰«æä½é€‰)
Led_Pwm:      0â”€â”€â”€â”€1â”€â”€â”€â”€2â”€â”€â”€â”€3â”€â”€â”€â”€4â”€â”€â”€â”€5â”€â”€â”€â”€6â”€â”€â”€â”€7â”€â”€â”€â”€8â”€â”€â”€â”€9 (PWMè®¡æ•°)
```

---

### 7. ä¸»å‡½æ•°è¯¦è§£

```c
void main()
{
    // ========== åˆå§‹åŒ–é˜¶æ®µ ==========
    read_t();          // é¦–æ¬¡è¯»å–æ¸©åº¦ (DS18B20 éœ€è¦è½¬æ¢æ—¶é—´)
    Delay750ms();      // ç­‰å¾… DS18B20 å®Œæˆè½¬æ¢
    System_Init();     // åˆå§‹åŒ–ç³»ç»Ÿ (æ—¶é’Ÿã€ç«¯å£ã€å¤–è®¾)
    Timer0Init();      // å¯åŠ¨å®šæ—¶å™¨ä¸­æ–­

    // ========== ä¸»å¾ªç¯ ==========
    while (1)
    {
        Key_Proc();    // æŒ‰é”®å¤„ç† (å®é™… 10ms æ‰§è¡Œä¸€æ¬¡)
        Seg_Proc();    // æ˜¾ç¤ºå¤„ç† (å®é™… 500ms æ‰§è¡Œä¸€æ¬¡)
        Led_Proc();    // LED å¤„ç† (æ¯æ¬¡å¾ªç¯éƒ½æ‰§è¡Œ)
    }
    // æ³¨æ„ï¼šä¸­æ–­ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€åœ¨ä¸»å¾ªç¯ä¸­è°ƒç”¨
}
```

**å¯åŠ¨æ—¶åº**:
```
ä¸Šç”µ
 â”‚
 â”œâ”€> read_t()        (è§¦å‘æ¸©åº¦è½¬æ¢)
 â”‚
 â”œâ”€> Delay750ms()    (ç­‰å¾…è½¬æ¢å®Œæˆ)
 â”‚
 â”œâ”€> System_Init()   (åˆå§‹åŒ–å¤–è®¾)
 â”‚
 â”œâ”€> Timer0Init()    (å¯åŠ¨ä¸­æ–­)
 â”‚
 â””â”€> while(1)        (è¿›å…¥ä¸»å¾ªç¯)
      â”‚
      â”œâ”€> Key_Proc()   (10ms é—´éš”)
      â”œâ”€> Seg_Proc()   (500ms é—´éš”)
      â”œâ”€> Led_Proc()   (æ¯æ¬¡å¾ªç¯)
      â””â”€> (é‡å¤)
```

---

## ğŸ”§ ä¼˜åŒ–æ–¹æ¡ˆ

### ä¼˜åŒ– 1: æ¶ˆé™¤ä»£ç é‡å¤ (DRY åŸåˆ™)

#### é—®é¢˜åˆ†æ

å½“å‰ä»£ç ä¸­ `main.c:71-102` å’Œ `main.c:114-160` å­˜åœ¨å¤§é‡é‡å¤ï¼š

```c
// é‡å¤ä»£ç å— 1 (çŸ­æŒ‰å¤„ç†)
case 14:
    if (Display_Mode == 1)
    {
        switch(Set_Index)
        {
            case 0:
                P_DIS[0]++;
                if(P_DIS[0] >= 70) P_DIS[0] = 70;
                break;
            case 1:
                P_DIS[1]++;
                if(P_DIS[1] >= 70) P_DIS[1] = 70;
                break;
        }
    }
    break;

// é‡å¤ä»£ç å— 2 (é•¿æŒ‰å¤„ç†)
case 14:
    if (Key_Long >= 250)
    {
        if (++Delay100ms >= 5)
        {
            Delay100ms = 0;
            if (Display_Mode == 1)
            {
                switch(Set_Index)
                {
                    case 0:
                        P_DIS[0]++;
                        if(P_DIS[0] >= 70) P_DIS[0] = 70;
                        break;
                    // ... å®Œå…¨ç›¸åŒçš„é€»è¾‘
                }
            }
        }
    }
    break;
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```c
/* æ–°å¢ï¼šå‚æ•°è°ƒèŠ‚å‡½æ•° */
void Adjust_Parameter(unsigned char index, char delta)
{
    if (Display_Mode != 1) return;  // ä»…åœ¨å‚æ•°æ¨¡å¼æœ‰æ•ˆ

    // èŒƒå›´ï¼š10-70
    #define PARAM_MIN 10
    #define PARAM_MAX 70

    switch (index)
    {
        case 0:  // TMAX
            P_DIS[0] += delta;
            if (P_DIS[0] < PARAM_MIN) P_DIS[0] = PARAM_MIN;
            if (P_DIS[0] > PARAM_MAX) P_DIS[0] = PARAM_MAX;
            break;

        case 1:  // TMIN
            P_DIS[1] += delta;
            if (P_DIS[1] < PARAM_MIN) P_DIS[1] = PARAM_MIN;
            if (P_DIS[1] > PARAM_MAX) P_DIS[1] = PARAM_MAX;
            break;
    }
}

/* ä¼˜åŒ–åçš„æŒ‰é”®å¤„ç† */
void Key_Proc()
{
    // ... è¾¹æ²¿æ£€æµ‹ä»£ç ä¸å˜ ...

    // ========== çŸ­æŒ‰å¤„ç† ==========
    switch (Key_Down)
    {
        case 14:  // S6 åŠ 
            Adjust_Parameter(Set_Index, 1);  // âœ“ è°ƒç”¨å…¬å…±å‡½æ•°
            break;

        case 15:  // S7 å‡
            Adjust_Parameter(Set_Index, -1);  // âœ“ è°ƒç”¨å…¬å…±å‡½æ•°
            break;

        // ... å…¶ä»–æŒ‰é”® ...
    }

    // ========== é•¿æŒ‰å¤„ç† ==========
    switch (Key_Old)
    {
        case 14:  // S6 é•¿æŒ‰
            if (Key_Long >= 250 && (++Delay100ms >= 5))
            {
                Delay100ms = 0;
                Adjust_Parameter(Set_Index, 1);  // âœ“ å¤ç”¨ç›¸åŒå‡½æ•°
            }
            break;

        case 15:  // S7 é•¿æŒ‰
            if (Key_Long >= 250 && (++Delay100ms >= 5))
            {
                Delay100ms = 0;
                Adjust_Parameter(Set_Index, -1);  // âœ“ å¤ç”¨ç›¸åŒå‡½æ•°
            }
            break;
    }
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- å‡å°‘ä»£ç è¡Œæ•°ï¼š~80 è¡Œ -> ~50 è¡Œ
- æé«˜å¯ç»´æŠ¤æ€§ï¼šä¿®æ”¹è¾¹ç•Œå€¼ä»…éœ€æ”¹ä¸€å¤„
- å¢å¼ºå¯è¯»æ€§ï¼šä¸šåŠ¡é€»è¾‘æ›´æ¸…æ™°

---

### ä¼˜åŒ– 2: ä½¿ç”¨å®å®šä¹‰æ›¿ä»£é­”æ•°

#### é—®é¢˜åˆ†æ

å½“å‰ä»£ç å­˜åœ¨å¤§é‡ç¡¬ç¼–ç æ•°å€¼ï¼š

```c
case 12:  // æŒ‰é”®å€¼ 12 æ˜¯ä»€ä¹ˆï¼Ÿ
if (P_DIS[0] >= 70)  // 70 çš„å«ä¹‰ï¼Ÿ
if (++Tick == 250)   // 250ms æ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿ
```

#### ä¼˜åŒ–æ–¹æ¡ˆ

```c
/* ========== é…ç½®å‚æ•°å®šä¹‰ ========== */

// æŒ‰é”®é”®å€¼å®šä¹‰
#define KEY_S4  12
#define KEY_S5  13
#define KEY_S6  14
#define KEY_S7  15
#define KEY_S8  16

// æ¸©åº¦å‚æ•°
#define TEMP_MIN_LIMIT     10    // æœ€ä½å¯è®¾ç½®æ¸©åº¦
#define TEMP_MAX_LIMIT     70    // æœ€é«˜å¯è®¾ç½®æ¸©åº¦
#define DEFAULT_TMAX       30    // é»˜è®¤æœ€å¤§é˜ˆå€¼
#define DEFAULT_TMIN       20    // é»˜è®¤æœ€å°é˜ˆå€¼

// æ—¶åºå‚æ•°
#define KEY_SCAN_PERIOD    10    // æŒ‰é”®æ‰«æå‘¨æœŸ (ms)
#define SEG_REFRESH_PERIOD 500   // æ•°ç ç®¡åˆ·æ–°å‘¨æœŸ (ms)
#define BLINK_PERIOD       250   // é—ªçƒå‘¨æœŸ (ms)
#define LONG_PRESS_TIME    250   // é•¿æŒ‰è§¦å‘æ—¶é—´ (ms)
#define FAST_REPEAT_DELAY  50    // å¿«é€Ÿé‡å¤é—´éš” (5 * 10ms)

// æ˜¾ç¤ºæ¨¡å¼
#define MODE_TEMP          0     // æ¸©åº¦æ˜¾ç¤ºæ¨¡å¼
#define MODE_PARAM         1     // å‚æ•°è®¾ç½®æ¨¡å¼

// æ®µç å®šä¹‰
#define SEG_BLANK          10    // ç©ºç™½
#define SEG_C              11    // å­—ç¬¦ 'C'
#define SEG_P              12    // å­—ç¬¦ 'P'
#define SEG_MINUS          13    // å­—ç¬¦ '-'

// LED PWM ç­‰çº§
#define LED_LEVEL_HIGH     3     // é«˜æ¸© (25%)
#define LED_LEVEL_NORMAL   6     // æ­£å¸¸ (50%)
#define LED_LEVEL_LOW      9     // ä½æ¸© (75%)

/* ========== ä¼˜åŒ–åçš„ä»£ç  ========== */

// æŒ‰é”®å¤„ç†
switch (Key_Down)
{
    case KEY_S4:  // âœ“ æ¸…æ™°æ˜“è¯»
        Display_Mode++;
        if (Display_Mode == 2)
        {
            if (P_DIS[0] > P_DIS[1])
            {
                TMAX = P_DIS[0];
                TMIN = P_DIS[1];
                Display_Mode = MODE_TEMP;  // âœ“ è¯­ä¹‰åŒ–
                Error = 0;
            }
            else
            {
                Display_Mode = MODE_TEMP;
                P_DIS[0] = DEFAULT_TMAX;   // âœ“ ä¸€ç›®äº†ç„¶
                P_DIS[1] = DEFAULT_TMIN;
                TMAX = DEFAULT_TMAX;
                TMIN = DEFAULT_TMIN;
                Error = 1;
            }
        }
        break;

    case KEY_S6:  // âœ“ è‡ªæ–‡æ¡£åŒ–
        Adjust_Parameter(Set_Index, 1);
        break;
}

// æ¸©åº¦æ˜¾ç¤º
case MODE_TEMP:  // âœ“ æ¯” case 0 æ›´æ¸…æ™°
    Seg_Buf[0] = SEG_C;
    Seg_Buf[1] = SEG_BLANK;
    // ...
    break;

// é—ªçƒæ§åˆ¶
if (++Tick == BLINK_PERIOD)  // âœ“ å‚æ•°å«ä¹‰æ˜ç¡®
{
    Tick = 0;
    Mode1_Flag ^= 1;
}
```

---

### ä¼˜åŒ– 3: èŒè´£åˆ†ç¦» (SOLID åŸåˆ™)

#### é—®é¢˜åˆ†æ

å½“å‰ `Key_Proc()` å‡½æ•°æ··åˆäº†ä¸‰ä¸ªèŒè´£ï¼š
1. æŒ‰é”®æ‰«æ (ç¡¬ä»¶å±‚)
2. è¾¹æ²¿æ£€æµ‹ (é©±åŠ¨å±‚)
3. ä¸šåŠ¡é€»è¾‘ (åº”ç”¨å±‚)

è¿åäº†**å•ä¸€èŒè´£åŸåˆ™**ã€‚

#### ä¼˜åŒ–æ–¹æ¡ˆ

```c
/* ========== ç¡¬ä»¶æŠ½è±¡å±‚ ========== */
unsigned char Key_Scan(void)
{
    return Key_Read();  // ä»…è´Ÿè´£è¯»å–ç¡¬ä»¶çŠ¶æ€
}

/* ========== é©±åŠ¨å±‚ ========== */
typedef struct
{
    unsigned char current;   // å½“å‰çŠ¶æ€
    unsigned char last;      // ä¸Šæ¬¡çŠ¶æ€
    unsigned char down;      // ä¸‹é™æ²¿æ ‡å¿—
    unsigned char up;        // ä¸Šå‡æ²¿æ ‡å¿—
    unsigned int long_time;  // é•¿æŒ‰è®¡æ—¶
} KeyDriver_t;

KeyDriver_t key_driver = {0};

void Key_Driver_Update(void)
{
    key_driver.current = Key_Scan();

    // è¾¹æ²¿æ£€æµ‹
    key_driver.down = key_driver.current & (key_driver.last ^ key_driver.current);
    key_driver.up = ~key_driver.current & (key_driver.last ^ key_driver.current);
    key_driver.last = key_driver.current;

    // é•¿æŒ‰è®¡æ—¶
    if ((key_driver.current == KEY_S6) || (key_driver.current == KEY_S7))
    {
        if (key_driver.long_time < 65535)
            key_driver.long_time++;
    }
    else
    {
        key_driver.long_time = 0;
    }
}

unsigned char Key_IsPressed(unsigned char key_code)
{
    return (key_driver.down == key_code);
}

unsigned char Key_IsLongPressed(unsigned char key_code)
{
    return (key_driver.current == key_code) &&
           (key_driver.long_time >= LONG_PRESS_TIME);
}

/* ========== åº”ç”¨å±‚ ========== */
void Key_Handler(void)
{
    // ========== æ¨¡å¼åˆ‡æ¢ ==========
    if (Key_IsPressed(KEY_S4))
    {
        Mode_Switch();  // æ¨¡å¼åˆ‡æ¢é€»è¾‘ç‹¬ç«‹å°è£…
    }

    // ========== è®¾ç½®é¡¹åˆ‡æ¢ ==========
    if (Key_IsPressed(KEY_S5))
    {
        if (Display_Mode == MODE_PARAM)
            Set_Index = (Set_Index + 1) % 2;
    }

    // ========== å‚æ•°è°ƒèŠ‚ ==========
    if (Key_IsPressed(KEY_S6))
        Adjust_Parameter(Set_Index, 1);

    if (Key_IsPressed(KEY_S7))
        Adjust_Parameter(Set_Index, -1);

    // ========== é•¿æŒ‰å¿«é€Ÿè°ƒèŠ‚ ==========
    static unsigned int fast_delay = 0;

    if (Key_IsLongPressed(KEY_S6))
    {
        if (++fast_delay >= FAST_REPEAT_DELAY)
        {
            fast_delay = 0;
            Adjust_Parameter(Set_Index, 1);
        }
    }
    else if (Key_IsLongPressed(KEY_S7))
    {
        if (++fast_delay >= FAST_REPEAT_DELAY)
        {
            fast_delay = 0;
            Adjust_Parameter(Set_Index, -1);
        }
    }
    else
    {
        fast_delay = 0;
    }

    // ========== æ¢å¤é»˜è®¤ ==========
    if (Key_IsPressed(KEY_S8))
        Reset_To_Default();
}

/* ========== ä¸šåŠ¡é€»è¾‘å‡½æ•° ========== */
void Mode_Switch(void)
{
    Display_Mode++;
    if (Display_Mode == 2)  // é€€å‡ºå‚æ•°æ¨¡å¼
    {
        if (P_DIS[0] > P_DIS[1])  // éªŒè¯é€šè¿‡
        {
            TMAX = P_DIS[0];
            TMIN = P_DIS[1];
            Error = 0;
        }
        else  // éªŒè¯å¤±è´¥
        {
            Reset_To_Default();
            Error = 1;
        }
        Display_Mode = MODE_TEMP;
    }
}

void Reset_To_Default(void)
{
    TMAX = DEFAULT_TMAX;
    TMIN = DEFAULT_TMIN;
    P_DIS[0] = DEFAULT_TMAX;
    P_DIS[1] = DEFAULT_TMIN;
    Display_Mode = MODE_TEMP;
}

/* ========== ä¸»å¾ªç¯è°ƒç”¨ ========== */
void main()
{
    // ... åˆå§‹åŒ– ...

    while (1)
    {
        Key_Driver_Update();  // æ›´æ–°é©±åŠ¨çŠ¶æ€
        Key_Handler();        // å¤„ç†ä¸šåŠ¡é€»è¾‘
        Seg_Proc();
        Led_Proc();
    }
}
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… æ¸…æ™°çš„å±‚æ¬¡ç»“æ„ï¼šç¡¬ä»¶ -> é©±åŠ¨ -> åº”ç”¨
- âœ… æ˜“äºæµ‹è¯•ï¼šå¯ç‹¬ç«‹æµ‹è¯•é©±åŠ¨å±‚
- âœ… æ˜“äºç§»æ¤ï¼šæ›´æ¢ç¡¬ä»¶åªéœ€ä¿®æ”¹ `Key_Scan()`
- âœ… æ˜“äºæ‰©å±•ï¼šæ–°å¢æŒ‰é”®åŠŸèƒ½åªéœ€åœ¨åº”ç”¨å±‚æ·»åŠ 

---

### ä¼˜åŒ– 4: æ·»åŠ å‚æ•°éªŒè¯å‡½æ•°

```c
/* å‚æ•°éªŒè¯å‡½æ•° */
typedef enum
{
    PARAM_VALID,           // å‚æ•°åˆæ³•
    PARAM_ERR_RANGE,       // è¶…å‡ºèŒƒå›´
    PARAM_ERR_RELATION     // TMAX <= TMIN
} ParamError_t;

ParamError_t Validate_Parameters(unsigned char tmax, unsigned char tmin)
{
    // èŒƒå›´æ£€æŸ¥
    if (tmax < TEMP_MIN_LIMIT || tmax > TEMP_MAX_LIMIT)
        return PARAM_ERR_RANGE;

    if (tmin < TEMP_MIN_LIMIT || tmin > TEMP_MAX_LIMIT)
        return PARAM_ERR_RANGE;

    // å…³ç³»æ£€æŸ¥
    if (tmax <= tmin)
        return PARAM_ERR_RELATION;

    return PARAM_VALID;
}

/* ä¼˜åŒ–åçš„æ¨¡å¼åˆ‡æ¢ */
void Mode_Switch(void)
{
    Display_Mode++;
    if (Display_Mode == 2)
    {
        ParamError_t error = Validate_Parameters(P_DIS[0], P_DIS[1]);

        switch (error)
        {
            case PARAM_VALID:
                TMAX = P_DIS[0];
                TMIN = P_DIS[1];
                Error = 0;
                break;

            case PARAM_ERR_RANGE:
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸åŒçš„é”™è¯¯å¤„ç†
                Reset_To_Default();
                Error = 1;
                break;

            case PARAM_ERR_RELATION:
                Reset_To_Default();
                Error = 1;
                break;
        }

        Display_Mode = MODE_TEMP;
    }
}
```

---

## ğŸ“Š æ€§èƒ½åˆ†æ

### CPU å ç”¨ç‡ä¼°ç®—

```c
/* 1ms ä¸­æ–­æœåŠ¡å‡½æ•°è€—æ—¶åˆ†æ */
void Timer0Server() interrupt 1
{
    // å‡é€Ÿè®¡æ•°å™¨ç»´æŠ¤: ~5Î¼s
    if (++Key_Slow_Down == 10) Key_Slow_Down = 0;
    if (++Seg_Slow_Down == 500) Seg_Slow_Down = 0;

    // æ•°ç ç®¡æ‰«æ: ~50Î¼s (I/O æ“ä½œ)
    if (++Seg_Pos == 8) Seg_Pos = 0;
    Seg_Disp(Seg_Pos, Seg_Buf[Seg_Pos], Seg_Point[Seg_Pos]);

    // é—ªçƒæ§åˆ¶: ~3Î¼s
    if (Display_Mode == 1)
    {
        if (++Tick == 250)
        {
            Tick = 0;
            Mode1_Flag ^= 1;
        }
    }

    // é•¿æŒ‰æ£€æµ‹: ~5Î¼s
    if ((Key_Old == 14) || (Key_Old == 15))
    {
        if (++Key_Long == 65535) Key_Long = 0;
    }
    else
    {
        Key_Long = 0;
    }

    // LED PWM: ~50Î¼s (I/O æ“ä½œ)
    if (++Led_Pwm == 12) Led_Pwm = 0;
    if (Led_Pwm < Led_Level)
        Led_Disp(Seg_Pos, ucLed[Seg_Pos]);
    else
        Led_Disp(Seg_Pos, 0);
}

/* ä¸­æ–­è€—æ—¶æ€»è®¡: ~113Î¼s */
/* CPU å ç”¨ç‡: 113Î¼s / 1000Î¼s = 11.3% */
```

### ä¸»å¾ªç¯æ‰§è¡Œé¢‘ç‡

```c
/* ä¸»å¾ªç¯å‡½æ•°è€—æ—¶åˆ†æ */
while (1)
{
    Key_Proc();   // 10ms æ‰§è¡Œä¸€æ¬¡, è€—æ—¶ ~20Î¼s
    Seg_Proc();   // 500ms æ‰§è¡Œä¸€æ¬¡, è€—æ—¶ ~100Î¼s (å«æ¸©åº¦è¯»å–)
    Led_Proc();   // æ¯æ¬¡å¾ªç¯æ‰§è¡Œ, è€—æ—¶ ~10Î¼s
}

/* ä¸»å¾ªç¯æ‰§è¡Œå‘¨æœŸ: çº¦ 100-200Î¼s */
/* ç©ºé—²æ—¶é—´: >99% */
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### åŠŸèƒ½æµ‹è¯•

```c
/* æµ‹è¯•ç”¨ä¾‹ 1: æ¸©åº¦é˜ˆå€¼è¾¹ç•Œæµ‹è¯• */
void Test_Temperature_Boundary()
{
    // æµ‹è¯•æ¡ä»¶è®¾ç½®
    TMAX = 30;
    TMIN = 20;

    // æµ‹è¯•ç”¨ä¾‹ 1.1: T = 19Â°C (ä½äº TMIN)
    t = 19.0;
    Led_Proc();
    // é¢„æœŸ: ucLed[2] = 1, ucLed[1] = 0, ucLed[0] = 0

    // æµ‹è¯•ç”¨ä¾‹ 1.2: T = 20Â°C (ç­‰äº TMIN)
    t = 20.0;
    Led_Proc();
    // é¢„æœŸ: ucLed[2] = 1, ucLed[1] = 1, ucLed[0] = 0

    // æµ‹è¯•ç”¨ä¾‹ 1.3: T = 25Â°C (æ­£å¸¸èŒƒå›´)
    t = 25.0;
    Led_Proc();
    // é¢„æœŸ: ucLed[2] = 0, ucLed[1] = 1, ucLed[0] = 0

    // æµ‹è¯•ç”¨ä¾‹ 1.4: T = 30Â°C (ç­‰äº TMAX)
    t = 30.0;
    Led_Proc();
    // é¢„æœŸ: ucLed[2] = 0, ucLed[1] = 1, ucLed[0] = 1

    // æµ‹è¯•ç”¨ä¾‹ 1.5: T = 31Â°C (é«˜äº TMAX)
    t = 31.0;
    Led_Proc();
    // é¢„æœŸ: ucLed[2] = 0, ucLed[1] = 0, ucLed[0] = 1
}

/* æµ‹è¯•ç”¨ä¾‹ 2: å‚æ•°è®¾ç½®éªŒè¯ */
void Test_Parameter_Validation()
{
    // æµ‹è¯•ç”¨ä¾‹ 2.1: åˆæ³•å‚æ•°
    P_DIS[0] = 40;  // TMAX
    P_DIS[1] = 30;  // TMIN
    // æŒ‰ S4 ä¿å­˜
    // é¢„æœŸ: TMAX = 40, TMIN = 30, Error = 0

    // æµ‹è¯•ç”¨ä¾‹ 2.2: éæ³•å‚æ•° (TMAX < TMIN)
    P_DIS[0] = 20;
    P_DIS[1] = 30;
    // æŒ‰ S4 ä¿å­˜
    // é¢„æœŸ: æ¢å¤é»˜è®¤å€¼, Error = 1, ucLed[3] = 1

    // æµ‹è¯•ç”¨ä¾‹ 2.3: éæ³•å‚æ•° (TMAX = TMIN)
    P_DIS[0] = 25;
    P_DIS[1] = 25;
    // æŒ‰ S4 ä¿å­˜
    // é¢„æœŸ: æ¢å¤é»˜è®¤å€¼, Error = 1
}

/* æµ‹è¯•ç”¨ä¾‹ 3: é•¿æŒ‰åŠŸèƒ½ */
void Test_Long_Press()
{
    // åˆå§‹çŠ¶æ€
    Display_Mode = MODE_PARAM;
    Set_Index = 0;
    P_DIS[0] = 30;

    // æ¨¡æ‹ŸæŒ‰ä½ S6 é”® 500ms
    Key_Old = KEY_S6;
    for (int i = 0; i < 500; i++)
    {
        // æ¯ 1ms è°ƒç”¨ä¸­æ–­
        Timer0Server();

        // æ¯ 10ms è°ƒç”¨æŒ‰é”®å¤„ç†
        if (i % 10 == 0)
            Key_Proc();
    }

    // é¢„æœŸ: P_DIS[0] > 30 (è§¦å‘äº†å¿«é€Ÿå¢åŠ )
}
```

---

## ğŸ“Œ å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆæ¸©åº¦æ˜¾ç¤ºæ—¶æœ‰æ—¶ä¼šè·³å˜?

**åŸå› **: DS18B20 æ¸©åº¦è½¬æ¢éœ€è¦çº¦ 750msï¼Œå¦‚æœè¯»å–è¿‡å¿«å¯èƒ½å¾—åˆ°ä¸Šæ¬¡çš„å€¼ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```c
// ç¡®ä¿ Seg_Proc() çš„è°ƒç”¨å‘¨æœŸ >= 750ms
// å½“å‰è®¾ç½®: 500ms (ç•¥çŸ­)

// å»ºè®®ä¼˜åŒ–:
#define SEG_REFRESH_PERIOD 800  // æ”¹ä¸º 800ms
```

### Q2: æŒ‰é”®æœ‰æ—¶ä¼šè¿ç»­è§¦å‘å¤šæ¬¡?

**åŸå› **: æœºæ¢°æŒ‰é”®å­˜åœ¨æŠ–åŠ¨ï¼Œå¯èƒ½åœ¨ 10ms å†…äº§ç”Ÿå¤šæ¬¡è¾¹æ²¿ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```c
// å¢åŠ è½¯ä»¶æ¶ˆæŠ–
unsigned char Key_Debounce_Counter = 0;

void Key_Proc()
{
    Key_Val = Key_Read();

    // åªæœ‰ç¨³å®šçŠ¶æ€æ‰æ›´æ–°
    if (Key_Val == Key_Old)
    {
        if (++Key_Debounce_Counter >= 3)  // è¿ç»­ 3 æ¬¡ç›¸åŒ
        {
            Key_Debounce_Counter = 3;
            // è¿›è¡Œè¾¹æ²¿æ£€æµ‹...
        }
    }
    else
    {
        Key_Debounce_Counter = 0;
        Key_Old = Key_Val;
    }
}
```

### Q3: LED äº®åº¦ä¸å‡åŒ€?

**åŸå› **: PWM å‘¨æœŸä¸æ•°ç ç®¡æ‰«æå‘¨æœŸä¸åŒæ­¥ã€‚

**è§£å†³æ–¹æ¡ˆ**:
```c
// æ–¹æ¡ˆ 1: è°ƒæ•´ PWM å‘¨æœŸä¸ºæ‰«æå‘¨æœŸçš„æ•´æ•°å€
#define LED_PWM_PERIOD 8  // 8ms (æ‰«æå‘¨æœŸ)

// æ–¹æ¡ˆ 2: ä½¿ç”¨ç¡¬ä»¶ PWM è€Œéè½¯ä»¶ PWM
```

### Q4: å¦‚ä½•æ·»åŠ èœ‚é¸£å™¨æŠ¥è­¦?

**ç¤ºä¾‹ä»£ç **:
```c
// åœ¨ Led_Proc() ä¸­æ·»åŠ 
void Led_Proc()
{
    // ... ç°æœ‰ä»£ç  ...

    // æ¸©åº¦è¶…é™æ—¶å¯åŠ¨èœ‚é¸£å™¨
    if ((ucLed[0] == 1) || (ucLed[2] == 1))
    {
        Buzzer_On();  // éœ€è¦åœ¨ Init.h ä¸­å®ç°
    }
    else
    {
        Buzzer_Off();
    }
}
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

### ç›¸å…³æ•°æ®æ‰‹å†Œ

1. **STC15F2K60S2 æ•°æ®æ‰‹å†Œ**
   - èŠ¯ç‰‡ç‰¹æ€§ã€å¼•è„šå®šä¹‰ã€å¯„å­˜å™¨è¯´æ˜
   - å®šæ—¶å™¨é…ç½®ã€ä¸­æ–­ç³»ç»Ÿ

2. **DS18B20 æ¸©åº¦ä¼ æ„Ÿå™¨æ‰‹å†Œ**
   - å•æ€»çº¿åè®®ã€æ—¶åºè¦æ±‚
   - æ¸©åº¦è½¬æ¢ç²¾åº¦ã€åˆ†è¾¨ç‡è®¾ç½®

3. **74HC138 è¯‘ç å™¨æ‰‹å†Œ**
   - 3-8 çº¿è¯‘ç å™¨å·¥ä½œåŸç†
   - æ•°ç ç®¡åŠ¨æ€æ‰«æç”µè·¯

### æ¨èé˜…è¯»

- ã€Š51 å•ç‰‡æœº C è¯­è¨€ç¨‹åºè®¾è®¡å®æˆ˜ã€‹
- ã€ŠåµŒå…¥å¼ç³»ç»Ÿè®¾è®¡æ¨¡å¼ã€‹
- ã€Šä»£ç æ•´æ´ä¹‹é“ã€‹

---

## ğŸ“ ç‰ˆæœ¬å†å²

- **v1.0** (2026-02-03): åˆå§‹æ–‡æ¡£ç‰ˆæœ¬
  - å®Œæ•´æºç åˆ†æ
  - 4 ä¸ªä¼˜åŒ–æ–¹æ¡ˆ
  - æµ‹è¯•ç”¨ä¾‹å’Œ FAQ

---

## ğŸ“„ è®¸å¯è¯

æœ¬æ–‡æ¡£éµå¾ª CC BY-NC-SA 4.0 åè®®ï¼Œä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ã€‚
