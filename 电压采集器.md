# ç”µå‹é‡‡é›†å™¨

## ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [ç¡¬ä»¶é…ç½®](#ç¡¬ä»¶é…ç½®)
- [å…¨å±€å˜é‡è¯´æ˜](#å…¨å±€å˜é‡è¯´æ˜)
- [åŠŸèƒ½æ¨¡å—è¯¦è§£](#åŠŸèƒ½æ¨¡å—è¯¦è§£)
- [ä»£ç æµç¨‹å›¾](#ä»£ç æµç¨‹å›¾)
- [å…³é”®ç®—æ³•](#å…³é”®ç®—æ³•)
- [ä½¿ç”¨è¯´æ˜](#ä½¿ç”¨è¯´æ˜)

---

## ç³»ç»Ÿæ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº **STC89C52** å•ç‰‡æœºçš„ç”µå‹é‡‡é›†ä¸ç›‘æµ‹ç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

âœ… ç”µå‹æ•°æ®é‡‡é›†ï¼ˆ4ä½ç²¾åº¦ï¼‰
âœ… å®æ—¶æ•°æ®æ˜¾ç¤ºï¼ˆå››èˆäº”å…¥å¤„ç†ï¼‰
âœ… é˜ˆå€¼å‚æ•°è®¾ç½®ï¼ˆ1.0V ~ 6.0Vï¼‰
âœ… ä¸‹é™æ²¿è®¡æ•°ç»Ÿè®¡
âœ… LED çŠ¶æ€æŒ‡ç¤º
âœ… æŒ‰é”®é”™è¯¯æ£€æµ‹

---

## ç¡¬ä»¶é…ç½®

### å¤–è®¾æ¸…å•
| å¤–è®¾ | æ•°é‡ | åŠŸèƒ½ |
|------|------|------|
| æ•°ç ç®¡ | 6ä½ | æ˜¾ç¤ºç”µå‹/å‚æ•°/è®¡æ•° |
| æŒ‰é”® | 16ä¸ª | æ•°æ®è¾“å…¥ä¸æ¨¡å¼åˆ‡æ¢ |
| LED | 3ä¸ª | çŠ¶æ€æŒ‡ç¤º |

### æŒ‰é”®å®šä¹‰
| æŒ‰é”® | åŠŸèƒ½ |
|------|------|
| 1-10 | æ•°å­—è¾“å…¥ï¼ˆå¯¹åº”0-9ï¼‰ |
| 11 | ç¡®è®¤/è¿”å› |
| 12 | æ¨¡å¼åˆ‡æ¢ |
| 15 | å‚æ•°å¢åŠ  |
| 16 | å‚æ•°å‡å°‘ |

---

## å…¨å±€å˜é‡è¯´æ˜

### å¤´æ–‡ä»¶å¼•ç”¨
```c
#include <REGX52.H>   // å•ç‰‡æœºå¯„å­˜å™¨ä¸“ç”¨å¤´æ–‡ä»¶
#include <Key.h>      // æŒ‰é”®åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
#include <Seg.h>      // æ•°ç ç®¡åº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
#include <intrins.h>  // å†…éƒ¨å‡½æ•°åº“
#include <Led.h>      // LEDåº•å±‚é©±åŠ¨ä¸“ç”¨å¤´æ–‡ä»¶
```

### æŒ‰é”®ç›¸å…³å˜é‡
```c
unsigned char Key_Val;           // å½“å‰æŒ‰é”®å€¼
unsigned char Key_Down;          // æŒ‰é”®ä¸‹é™æ²¿æ ‡å¿—
unsigned char Key_Old;           // ä¸Šæ¬¡æŒ‰é”®å€¼
unsigned char Key_Up;            // æŒ‰é”®ä¸Šå‡æ²¿æ ‡å¿—
unsigned char Key_Slow_Down;    // æŒ‰é”®æ‰«æå‡é€Ÿè®¡æ•°å™¨
unsigned char Key_Error_Count;  // æŒ‰é”®é”™è¯¯è®¡æ•°å™¨ï¼ˆç´¯è®¡3æ¬¡è§¦å‘LEDï¼‰
```

### æ•°ç ç®¡ç›¸å…³å˜é‡
```c
unsigned char Seg_Buf[6] = {10,10,13,13,13,13};  // æ•°ç ç®¡æ˜¾ç¤ºç¼“å†²åŒº
unsigned char Seg_Point[6] = {0,0,0,0,0,0};     // å°æ•°ç‚¹æ§åˆ¶æ•°ç»„
unsigned char Seg_Pos;                           // æ•°ç ç®¡æ‰«æä½ç½®
unsigned int  Seg_Slow_Down;                     // æ•°ç ç®¡æ‰«æå‡é€Ÿè®¡æ•°å™¨
unsigned char Disp_Mode = 0;                     // æ˜¾ç¤ºæ¨¡å¼ï¼š0-ç”µå‹é‡‡é›† 1-æ•°æ®æ˜¾ç¤º 2-å‚æ•°è®¾ç½® 3-è®¡æ•°ç»Ÿè®¡
```

### ç”µå‹å¤„ç†å˜é‡
```c
unsigned char Voltage_Input[4] = {13,13,13,13};      // ç”µå‹è¾“å…¥ç¼“å†²åŒº
unsigned char Voltage_Data[4] = {0,0,0,0};           // ç”µå‹é‡‡é›†æ•°æ®
unsigned char Voltage_Input_Index;                   // è¾“å…¥ç´¢å¼•ï¼ˆ0-3ï¼‰
unsigned char Voltage_Data_Index;                    // æ•°æ®ç´¢å¼•
unsigned char Voltage_Val;                           // ä¸´æ—¶è¾“å…¥å€¼
unsigned char Voltage_Real_Data[3] = {0,0,0};        // å››èˆäº”å…¥åçš„3ä½æ•°æ®
unsigned int  Voltage_Real = 0;                      // å½“å‰ç”µå‹å€¼ï¼ˆ0-999ï¼‰
unsigned int  Voltage_Old = 0;                       // ä¸Šæ¬¡ç”µå‹å€¼ï¼ˆç”¨äºä¸‹é™æ²¿æ£€æµ‹ï¼‰
unsigned int  Voltage_Count = 0;                     // ä¸‹é™æ²¿è®¡æ•°å™¨
```

### å‚æ•°è®¾ç½®å˜é‡
```c
unsigned char Voltage_Setting_Data[3] = {3,0,0};  // é˜ˆå€¼å‚æ•°æ•°ç»„ï¼ˆé»˜è®¤3.00Vï¼‰
unsigned int  Voltage_Setting;                    // é˜ˆå€¼æ•´æ•°å€¼ï¼ˆ100-600ï¼‰
unsigned char Voltage_Setting_Data_Index;         // å‚æ•°ç´¢å¼•
```

### å®šæ—¶ä¸çŠ¶æ€å˜é‡
```c
unsigned int  Timer250;        // 250msè®¡æ—¶å™¨ï¼ˆç”¨äºé—ªçƒï¼‰
bit Input_Flag;                // é—ªçƒæ ‡å¿—ä½
unsigned int  Sys_Tick;        // ç³»ç»Ÿè®¡æ—¶å™¨ï¼ˆ1msç²¾åº¦ï¼‰
unsigned char ucLed[8] = {0};  // LEDçŠ¶æ€æ•°ç»„
unsigned char Led_Pos;         // LEDæ‰«æä½ç½®
```

---

## åŠŸèƒ½æ¨¡å—è¯¦è§£

### 1. æŒ‰é”®å¤„ç†å‡½æ•° `Key_Proc()`

#### åŠŸèƒ½æ¦‚è¿°
å¤„ç†æ‰€æœ‰æŒ‰é”®è¾“å…¥ï¼Œå®ç°æ•°æ®è¾“å…¥ã€æ¨¡å¼åˆ‡æ¢ã€å‚æ•°è°ƒèŠ‚ç­‰åŠŸèƒ½ã€‚

#### ä»£ç è¯¦è§£

##### 1.1 æŒ‰é”®æ‰«æä¸è¾¹æ²¿æ£€æµ‹
```c
void Key_Proc()
{
    unsigned char i;
    if (Key_Slow_Down) return;  // å‡é€Ÿæ§åˆ¶ï¼ˆ10msæ‰§è¡Œä¸€æ¬¡ï¼‰
    Key_Slow_Down = 1;

    Key_Val = Key_Read();                          // è¯»å–å½“å‰æŒ‰é”®å€¼
    Key_Down = Key_Val & (Key_Val ^ Key_Old);      // æ£€æµ‹ä¸‹é™æ²¿
    Key_Up = Key_Old & (Key_Val ^ Key_Old);        // æ£€æµ‹ä¸Šå‡æ²¿
    Key_Old = Key_Val;                             // ä¿å­˜å½“å‰å€¼
```

**è¾¹æ²¿æ£€æµ‹åŸç†ï¼š**
- **ä¸‹é™æ²¿**ï¼šå½“å‰æŒ‰ä¸‹ && ä¹‹å‰æœªæŒ‰ â†’ `Key_Val & (Key_Val ^ Key_Old)`
- **ä¸Šå‡æ²¿**ï¼šä¹‹å‰æŒ‰ä¸‹ && å½“å‰æœªæŒ‰ â†’ `Key_Old & (Key_Val ^ Key_Old)`

##### 1.2 æ•°å­—é”®è¾“å…¥ï¼ˆæŒ‰é”®1-10ï¼‰
```c
    if((Key_Down >= 1) && (Key_Down <= 10))
    {
        if(Voltage_Input_Index < 4)  // é˜²æ­¢è¶Šç•Œ
        {
            Key_Error_Count = 0;
            if(Disp_Mode == 0)  // ä»…åœ¨ç”µå‹é‡‡é›†æ¨¡å¼æœ‰æ•ˆ
            {
                Voltage_Val = Key_Down - 1;                 // æŒ‰é”®å€¼è½¬æ•°å­—ï¼ˆ1â†’0, 2â†’1...ï¼‰
                Voltage_Input[Voltage_Input_Index] = Voltage_Val;
                Voltage_Input_Index++;
            }
            else
            {
                Key_Error_Count++;  // é”™è¯¯æ¨¡å¼æŒ‰é”®ï¼Œç´¯åŠ é”™è¯¯è®¡æ•°
            }
        }
    }
```

##### 1.3 ç¡®è®¤é”®ï¼ˆæŒ‰é”®11ï¼‰
```c
    if(Key_Down == 11)
    {
        if(Disp_Mode == 0)  // ç”µå‹é‡‡é›†æ¨¡å¼ï¼šç¡®è®¤è¾“å…¥
        {
            if(Voltage_Input_Index == 4)  // å¿…é¡»è¾“å…¥æ»¡4ä½
            {
                Key_Error_Count = 0;

                // æ­¥éª¤1ï¼šä¿å­˜æ—§ç”µå‹å€¼
                Voltage_Old = Voltage_Real;

                // æ­¥éª¤2ï¼šå¤åˆ¶è¾“å…¥æ•°æ®
                for(i = 0; i < 4; i++)
                {
                    Voltage_Data[i] = Voltage_Input[i];
                }

                // æ­¥éª¤3ï¼šå››èˆäº”å…¥è®¡ç®—
                Voltage_Real_Data[0] = Voltage_Data[0];
                Voltage_Real_Data[1] = Voltage_Data[1];
                Voltage_Real_Data[2] = Voltage_Data[2];

                if(Voltage_Data[3] >= 5)  // ç¬¬4ä½â‰¥5æ—¶è¿›ä½
                {
                    Voltage_Real_Data[2]++;
                    if(Voltage_Real_Data[2] >= 10)
                    {
                        Voltage_Real_Data[2] = 0;
                        Voltage_Real_Data[1]++;
                    }
                    if(Voltage_Real_Data[1] >= 10)
                    {
                        Voltage_Real_Data[1] = 0;
                        Voltage_Real_Data[0]++;
                    }
                }

                // æ­¥éª¤4ï¼šè®¡ç®—æ•´æ•°å€¼
                Voltage_Real = Voltage_Real_Data[2] +
                              10 * Voltage_Real_Data[1] +
                              100 * Voltage_Real_Data[0];

                // æ­¥éª¤5ï¼šä¸‹é™æ²¿æ£€æµ‹
                Voltage_Setting = Voltage_Setting_Data[2] +
                                 10 * Voltage_Setting_Data[1] +
                                 100 * Voltage_Setting_Data[0];

                if((Voltage_Real < Voltage_Setting) &&
                   (Voltage_Old >= Voltage_Setting))
                {
                    Voltage_Count++;  // ä¸‹é™æ²¿è§¦å‘è®¡æ•°
                }

                Disp_Mode = 1;  // åˆ‡æ¢åˆ°æ•°æ®æ˜¾ç¤ºæ¨¡å¼
            }
            else
            {
                Key_Error_Count++;
            }
        }
        else  // å…¶ä»–æ¨¡å¼ï¼šè¿”å›ç”µå‹é‡‡é›†æ¨¡å¼
        {
            Voltage_Input_Index = 0;
            for(i = 0; i < 4; i++)
            {
                Voltage_Input[i] = 13;  // é‡ç½®ä¸ºç†„ç­çŠ¶æ€
            }
            Disp_Mode = 0;
        }
    }
```

##### 1.4 æ¨¡å¼åˆ‡æ¢é”®ï¼ˆæŒ‰é”®12ï¼‰
```c
    if(Key_Down == 12)
    {
        if(Disp_Mode != 0)  // ä»…åœ¨éé‡‡é›†æ¨¡å¼æœ‰æ•ˆ
        {
            Key_Error_Count = 0;
            if(++Disp_Mode == 4) Disp_Mode = 1;  // å¾ªç¯ï¼š1â†’2â†’3â†’1
        }
        else
        {
            Key_Error_Count++;
        }
    }
```

##### 1.5 å‚æ•°è°ƒèŠ‚é”®ï¼ˆæŒ‰é”®15/16ï¼‰
```c
    if(Key_Down == 15)  // å¢åŠ æŒ‰é”®
    {
        if(Disp_Mode == 2)  // ä»…åœ¨å‚æ•°è®¾ç½®æ¨¡å¼æœ‰æ•ˆ
        {
            Key_Error_Count = 0;
            Voltage_Setting_Data[1] += 5;  // åä½åŠ 5ï¼ˆæ­¥è¿›0.5Vï¼‰

            if(Voltage_Setting_Data[1] == 10)
            {
                Voltage_Setting_Data[1] = 0;
                Voltage_Setting_Data[0] += 1;
            }

            // ä¸Šé™æ£€æµ‹ï¼š6.5V â†’ 1.0V
            if((Voltage_Setting_Data[0] == 6) &&
               (Voltage_Setting_Data[1] == 5))
            {
                Voltage_Setting_Data[0] = 1;
                Voltage_Setting_Data[1] = 0;
            }
        }
        else
        {
            Key_Error_Count++;
        }
    }

    if(Key_Down == 16)  // å‡å°‘æŒ‰é”®
    {
        if(Disp_Mode == 2)
        {
            Key_Error_Count = 0;

            if(Voltage_Setting_Data[1] == 0)
            {
                Voltage_Setting_Data[1] = 5;
                Voltage_Setting_Data[0] -= 1;
            }
            else
            {
                Voltage_Setting_Data[1] -= 5;
            }

            // ä¸‹é™æ£€æµ‹ï¼š0.5V â†’ 6.0V
            if((Voltage_Setting_Data[0] == 0) &&
               (Voltage_Setting_Data[1] == 5))
            {
                Voltage_Setting_Data[1] = 0;
                Voltage_Setting_Data[0] = 6;
            }
        }
        else
        {
            Key_Error_Count++;
        }
    }
}
```

---

### 2. æ•°ç ç®¡æ˜¾ç¤ºå‡½æ•° `Seg_Proc()`

#### åŠŸèƒ½æ¦‚è¿°
æ ¹æ®å½“å‰æ˜¾ç¤ºæ¨¡å¼æ›´æ–°æ•°ç ç®¡æ˜¾ç¤ºç¼“å†²åŒºã€‚

#### ä»£ç è¯¦è§£

```c
void Seg_Proc()
{
    unsigned char i;
    if (Seg_Slow_Down) return;  // å‡é€Ÿæ§åˆ¶ï¼ˆ50msæ‰§è¡Œä¸€æ¬¡ï¼‰
    Seg_Slow_Down = 1;

    switch(Disp_Mode)
    {
        case 0:  // ç”µå‹é‡‡é›†æ¨¡å¼
            Seg_Buf[0] = 10;  // ç†„ç­
            Seg_Buf[1] = 10;

            // æ˜¾ç¤ºè¾“å…¥çš„4ä½æ•°æ®
            Seg_Buf[2] = Voltage_Input[0];
            Seg_Buf[3] = Voltage_Input[1];
            Seg_Point[3] = 0;  // æ— å°æ•°ç‚¹
            Seg_Buf[4] = Voltage_Input[2];
            Seg_Buf[5] = Voltage_Input[3];

            // å½“å‰è¾“å…¥ä½é—ªçƒï¼ˆä»…åœ¨æœªè¾“å…¥æ»¡æ—¶ï¼‰
            if(Voltage_Input_Index < 4 && Input_Flag == 1)
            {
                Seg_Buf[Voltage_Input_Index + 2] = 10;  // é—ªçƒä½ç†„ç­
            }
            break;

        case 1:  // æ•°æ®æ˜¾ç¤ºæ¨¡å¼
            Seg_Buf[0] = 14;  // æ˜¾ç¤º 'U'
            Seg_Buf[1] = 10;
            Seg_Buf[2] = 10;
            Seg_Buf[3] = Voltage_Data[0];
            Seg_Point[3] = 1;  // æ˜¾ç¤ºå°æ•°ç‚¹ï¼ˆX.XXæ ¼å¼ï¼‰
            Seg_Buf[4] = Voltage_Data[1];
            Seg_Buf[5] = Voltage_Data[2];

            // å››èˆäº”å…¥æ˜¾ç¤º
            if(Voltage_Data[3] >= 5)
            {
                Seg_Buf[5] = Voltage_Data[2] + 1;
            }
            if(Seg_Buf[5] >= 10)
            {
                Seg_Buf[5] = 0;
                Seg_Buf[4] = Voltage_Data[1] + 1;
            }
            if(Seg_Buf[4] >= 10)
            {
                Seg_Buf[4] = 0;
                Seg_Buf[3] = Voltage_Data[0] + 1;
            }
            if(Seg_Buf[3] == 10)
            {
                Seg_Buf[3] = 0;
                Seg_Buf[2] = 1;  // è¿›ä½åˆ°åä½
            }
            break;

        case 2:  // å‚æ•°è®¾ç½®æ¨¡å¼
            Seg_Buf[0] = 15;  // æ˜¾ç¤º 'P'
            Seg_Buf[1] = 10;
            Seg_Buf[2] = 10;
            Seg_Buf[3] = Voltage_Setting_Data[0];
            Seg_Point[3] = 1;  // æ˜¾ç¤ºå°æ•°ç‚¹ï¼ˆX.X0æ ¼å¼ï¼‰
            Seg_Buf[4] = Voltage_Setting_Data[1];
            Seg_Buf[5] = Voltage_Setting_Data[2];
            break;

        case 3:  // è®¡æ•°ç»Ÿè®¡æ¨¡å¼
            Seg_Buf[0] = 16;  // æ˜¾ç¤º 'N'
            Seg_Buf[1] = Voltage_Count / 10000 % 10;
            Seg_Buf[2] = Voltage_Count / 1000 % 10;
            Seg_Buf[3] = Voltage_Count / 100 % 10;
            Seg_Point[3] = 0;  // æ— å°æ•°ç‚¹
            Seg_Buf[4] = Voltage_Count / 10 % 10;
            Seg_Buf[5] = Voltage_Count % 10;

            // å‰å¯¼é›¶æ¶ˆéš
            for(i = 0; i < 5; i++)
            {
                if(Seg_Buf[i] == 0) Seg_Buf[i] = 10;
            }
            break;
    }
}
```

#### æ˜¾ç¤ºæ ¼å¼è¡¨

| æ¨¡å¼ | æ˜¾ç¤ºæ ¼å¼ | ç¤ºä¾‹ |
|------|----------|------|
| 0 | `--X.XXX` | `--3.456`ï¼ˆè¾“å…¥ä¸­ï¼‰<br>`--3.45_`ï¼ˆé—ªçƒä½ï¼‰ |
| 1 | `U--X.XX` | `U--3.46`ï¼ˆå››èˆäº”å…¥ï¼‰ |
| 2 | `P--X.X0` | `P--3.00`ï¼ˆé˜ˆå€¼ï¼‰ |
| 3 | `NXXXXX` | `N----5`ï¼ˆè®¡æ•°5æ¬¡ï¼‰ |

---

### 3. LED æ§åˆ¶å‡½æ•° `Led_Proc()`

#### åŠŸèƒ½æ¦‚è¿°
æ ¹æ®ç³»ç»ŸçŠ¶æ€æ§åˆ¶3ä¸ªLEDçš„äº®ç­ã€‚

#### ä»£ç è¯¦è§£
```c
void Led_Proc()
{
    // LED0ï¼šç³»ç»Ÿè®¡æ—¶å™¨æŒ‡ç¤º
    if(Sys_Tick >= 5000)
    {
        ucLed[0] = 1;  // è®¡æ—¶å™¨â‰¥5sæ—¶ç‚¹äº®
    }
    else
    {
        ucLed[0] = 0;
    }

    // LED1ï¼šè®¡æ•°å¥‡å¶æŒ‡ç¤º
    if((Voltage_Count % 2) != 0)
    {
        ucLed[1] = 1;  // è®¡æ•°ä¸ºå¥‡æ•°æ—¶ç‚¹äº®
    }
    else
    {
        ucLed[1] = 0;
    }

    // LED2ï¼šé”™è¯¯æŒ‡ç¤º
    if(Key_Error_Count == 3)
    {
        ucLed[2] = 1;  // é”™è¯¯ç´¯è®¡3æ¬¡æ—¶ç‚¹äº®
    }
    else if(Key_Error_Count == 0)
    {
        ucLed[2] = 0;  // æ¸…é›¶æ—¶ç†„ç­
    }
}
```

#### LED åŠŸèƒ½è¡¨

| LED | è§¦å‘æ¡ä»¶ | åŠŸèƒ½è¯´æ˜ |
|-----|----------|----------|
| LED0 | `Sys_Tick â‰¥ 5000` | ç”µå‹ä½äºé˜ˆå€¼æ—¶é—´è¶…è¿‡5ç§’ |
| LED1 | `Voltage_Count % 2 â‰  0` | ä¸‹é™æ²¿è®¡æ•°ä¸ºå¥‡æ•° |
| LED2 | `Key_Error_Count == 3` | æŒ‰é”®æ“ä½œé”™è¯¯3æ¬¡ï¼ˆæŠ¥è­¦ï¼‰ |

---

### 4. å®šæ—¶å™¨åˆå§‹åŒ– `Timer0Init()`

#### ä»£ç è¯¦è§£
```c
void Timer0Init(void)  // 1ms@12MHz
{
    TMOD &= 0xF0;  // æ¸…é™¤å®šæ—¶å™¨0æ§åˆ¶ä½
    TMOD |= 0x01;  // è®¾ç½®ä¸ºæ¨¡å¼1ï¼ˆ16ä½å®šæ—¶å™¨ï¼‰
    TL0 = 0x18;    // åˆå€¼ä½8ä½
    TH0 = 0xFC;    // åˆå€¼é«˜8ä½
    TF0 = 0;       // æ¸…é™¤æº¢å‡ºæ ‡å¿—
    TR0 = 1;       // å¯åŠ¨å®šæ—¶å™¨0
    ET0 = 1;       // ä½¿èƒ½å®šæ—¶å™¨0ä¸­æ–­
    EA = 1;        // ä½¿èƒ½æ€»ä¸­æ–­
}
```

#### å®šæ—¶å™¨è®¡ç®—
- **æ™¶æŒ¯é¢‘ç‡**ï¼š12MHz
- **å®šæ—¶å‘¨æœŸ**ï¼š1ms
- **åˆå€¼è®¡ç®—**ï¼š65536 - 12000 = 53536 = 0xD118 â†’ **é”™è¯¯ï¼**

> **æ³¨æ„**ï¼šä»£ç ä¸­ `TL0=0x18, TH0=0xFC` â†’ åˆå€¼=0xFC18=64536
> å®é™…å®šæ—¶ï¼š(65536-64536) Ã— 1Âµs = **1ms** âœ…

---

### 5. å®šæ—¶å™¨ä¸­æ–­æœåŠ¡å‡½æ•° `Timer0Server()`

#### åŠŸèƒ½æ¦‚è¿°
1mså®šæ—¶ä¸­æ–­ï¼Œå¤„ç†æ‰€æœ‰å®šæ—¶ä»»åŠ¡ã€‚

#### ä»£ç è¯¦è§£
```c
void Timer0Server() interrupt 1
{
    // é‡è£…åˆå€¼
    TL0 = 0x18;
    TH0 = 0xFC;

    // ä»»åŠ¡1ï¼šæŒ‰é”®æ‰«æå‡é€Ÿï¼ˆ10msï¼‰
    if(++Key_Slow_Down == 10) Key_Slow_Down = 0;

    // ä»»åŠ¡2ï¼šæ•°ç ç®¡åˆ·æ–°å‡é€Ÿï¼ˆ50msï¼‰
    if(++Seg_Slow_Down == 50) Seg_Slow_Down = 0;

    // ä»»åŠ¡3ï¼šæ•°ç ç®¡åŠ¨æ€æ‰«æï¼ˆ1msï¼‰
    if(++Seg_Pos == 6) Seg_Pos = 0;
    Seg_Disp(Seg_Pos, Seg_Buf[Seg_Pos], Seg_Point[Seg_Pos]);

    // ä»»åŠ¡4ï¼šLEDåŠ¨æ€æ‰«æï¼ˆ1msï¼‰
    if(++Led_Pos == 8) Led_Pos = 0;
    Led_Disp(Led_Pos, ucLed[Led_Pos]);

    // ä»»åŠ¡5ï¼šé—ªçƒè®¡æ—¶ï¼ˆ250msï¼‰
    if(++Timer250 == 250)
    {
        Timer250 = 0;
        Input_Flag ^= 1;  // ç¿»è½¬é—ªçƒæ ‡å¿—
    }

    // ä»»åŠ¡6ï¼šç³»ç»Ÿè®¡æ—¶ï¼ˆç”µå‹ä½äºé˜ˆå€¼æ—¶è®¡æ—¶ï¼‰
    if(Voltage_Real < Voltage_Setting)
    {
        if(++Sys_Tick == 501) Sys_Tick = 500;  // ä¸Šé™é”å®š500ms
    }
}
```

#### ä¸­æ–­ä»»åŠ¡æ—¶åºè¡¨

| ä»»åŠ¡ | æ‰§è¡Œå‘¨æœŸ | åŠŸèƒ½ |
|------|----------|------|
| æŒ‰é”®æ‰«æå‡é€Ÿ | 10ms | æ§åˆ¶æŒ‰é”®å¤„ç†å‡½æ•°æ‰§è¡Œé¢‘ç‡ |
| æ•°ç ç®¡åˆ·æ–°å‡é€Ÿ | 50ms | æ§åˆ¶æ˜¾ç¤ºæ•°æ®æ›´æ–°é¢‘ç‡ |
| æ•°ç ç®¡æ‰«æ | 1ms | 6ä½æ•°ç ç®¡åŠ¨æ€æ‰«æ |
| LEDæ‰«æ | 1ms | 8ä¸ªLEDåŠ¨æ€æ‰«æ |
| é—ªçƒæ§åˆ¶ | 250ms | æ§åˆ¶è¾“å…¥ä½é—ªçƒ |
| ç³»ç»Ÿè®¡æ—¶ | 1ms | ç”µå‹ä½äºé˜ˆå€¼æ—¶ç´¯åŠ  |

---

### 6. ä¸»å‡½æ•° `main()`

#### ä»£ç è¯¦è§£
```c
void main()
{
    Timer0Init();  // åˆå§‹åŒ–å®šæ—¶å™¨

    while(1)  // ä¸»å¾ªç¯
    {
        Key_Proc();   // æŒ‰é”®å¤„ç†
        Seg_Proc();   // æ•°ç ç®¡æ•°æ®å¤„ç†
        Led_Proc();   // LEDçŠ¶æ€å¤„ç†
    }
}
```

---

## ä»£ç æµç¨‹å›¾

### ç³»ç»Ÿæ•´ä½“æµç¨‹
```
ç³»ç»Ÿä¸Šç”µ
    â†“
å®šæ—¶å™¨åˆå§‹åŒ–
    â†“
è¿›å…¥ä¸»å¾ªç¯ â”€â”€â”¬â”€â†’ Key_Proc()   (æŒ‰é”®å¤„ç†)
            â”œâ”€â†’ Seg_Proc()   (æ•°ç ç®¡æ•°æ®æ›´æ–°)
            â””â”€â†’ Led_Proc()   (LEDçŠ¶æ€æ›´æ–°)

å®šæ—¶å™¨ä¸­æ–­(1ms) â”€â”€â”¬â”€â†’ æ•°ç ç®¡åŠ¨æ€æ‰«æ
                 â”œâ”€â†’ LEDåŠ¨æ€æ‰«æ
                 â”œâ”€â†’ é—ªçƒè®¡æ—¶
                 â””â”€â†’ ç³»ç»Ÿè®¡æ—¶
```

### æ¨¡å¼åˆ‡æ¢çŠ¶æ€æœº
```
æ¨¡å¼0(ç”µå‹é‡‡é›†) â”€â”€[æŒ‰é”®11(è¾“å…¥æ»¡4ä½)]â”€â”€â†’ æ¨¡å¼1(æ•°æ®æ˜¾ç¤º)
                                            â†“
                        [æŒ‰é”®11] â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                        æ¨¡å¼0

æ¨¡å¼1(æ•°æ®æ˜¾ç¤º) â”€â”€[æŒ‰é”®12]â”€â”€â†’ æ¨¡å¼2(å‚æ•°è®¾ç½®)
                                  â†“
                            [æŒ‰é”®12]
                                  â†“
æ¨¡å¼2(å‚æ•°è®¾ç½®) â”€â”€[æŒ‰é”®12]â”€â”€â†’ æ¨¡å¼3(è®¡æ•°ç»Ÿè®¡)
                                  â†“
                            [æŒ‰é”®12]
                                  â†“
æ¨¡å¼3(è®¡æ•°ç»Ÿè®¡) â”€â”€[æŒ‰é”®12]â”€â”€â†’ æ¨¡å¼1(å¾ªç¯)
```

### ä¸‹é™æ²¿æ£€æµ‹æµç¨‹
```
è¾“å…¥ç”µå‹æ•°æ®(4ä½)
    â†“
æŒ‰ä¸‹ç¡®è®¤é”®(11)
    â†“
ä¿å­˜æ—§ç”µå‹å€¼ Voltage_Old
    â†“
å››èˆäº”å…¥è®¡ç®— Voltage_Real
    â†“
åˆ¤æ–­ï¼šVoltage_Real < Voltage_Setting
   ä¸” Voltage_Old â‰¥ Voltage_Setting
    â†“
   æ˜¯ â†’ Voltage_Count++
   å¦ â†’ ä¸è®¡æ•°
```

---

## å…³é”®ç®—æ³•

### 1. å››èˆäº”å…¥ç®—æ³•

#### ç®—æ³•åŸç†
è¾“å…¥4ä½å°æ•°ï¼ˆX.XXXï¼‰ï¼Œä¿ç•™3ä½ï¼ˆX.XXï¼‰ï¼Œç¬¬4ä½â‰¥5æ—¶å‘ç¬¬3ä½è¿›ä½ã€‚

#### ä»£ç å®ç°
```c
// ç¤ºä¾‹ï¼šè¾“å…¥ 3.456 â†’ è¾“å‡º 3.46
Voltage_Real_Data[0] = Voltage_Data[0];  // 3
Voltage_Real_Data[1] = Voltage_Data[1];  // 4
Voltage_Real_Data[2] = Voltage_Data[2];  // 5

if(Voltage_Data[3] >= 5)  // ç¬¬4ä½=6 â‰¥ 5
{
    Voltage_Real_Data[2]++;  // 5+1=6

    if(Voltage_Real_Data[2] >= 10)  // è¿›ä½æ£€æµ‹
    {
        Voltage_Real_Data[2] = 0;
        Voltage_Real_Data[1]++;
    }

    if(Voltage_Real_Data[1] >= 10)
    {
        Voltage_Real_Data[1] = 0;
        Voltage_Real_Data[0]++;
    }
}
// ç»“æœï¼šVoltage_Real_Data = {3, 4, 6}
```

#### æµ‹è¯•ç”¨ä¾‹
| è¾“å…¥ | ç¬¬4ä½ | è¾“å‡º | è¯´æ˜ |
|------|-------|------|------|
| 3.456 | 6 | 3.46 | å››èˆäº”å…¥å‘ä¸Š |
| 3.454 | 4 | 3.45 | å››èˆäº”å…¥å‘ä¸‹ |
| 3.999 | 9 | 4.00 | è¿ç»­è¿›ä½ |
| 0.005 | 5 | 0.01 | è¾¹ç•Œæƒ…å†µ |

---

### 2. ä¸‹é™æ²¿æ£€æµ‹ç®—æ³•

#### ç®—æ³•åŸç†
æ£€æµ‹ç”µå‹å€¼ä»"â‰¥é˜ˆå€¼"å˜ä¸º"<é˜ˆå€¼"çš„ç¬é—´ã€‚

#### é€»è¾‘è¡¨è¾¾å¼
```c
ä¸‹é™æ²¿æ¡ä»¶ï¼š
(Voltage_Real < Voltage_Setting) && (Voltage_Old >= Voltage_Setting)
```

#### æ—¶åºå›¾
```
æ—¶åˆ»      t0    t1    t2    t3    t4    t5
--------------------------------------------
Voltage   3.5   3.2   2.8   2.5   3.0   3.4
Setting   3.0   3.0   3.0   3.0   3.0   3.0
--------------------------------------------
æ£€æµ‹      Ã—     Ã—     âˆš     Ã—     Ã—     Ã—
è®¡æ•°      0     0     1     1     1     1

è¯´æ˜ï¼š
t0: 3.5 â‰¥ 3.0, æœªä¸‹é™
t1: 3.2 â‰¥ 3.0, æœªä¸‹é™
t2: 2.8 < 3.0 ä¸” ä¸Šæ¬¡(3.2) â‰¥ 3.0 â†’ ä¸‹é™æ²¿ï¼è®¡æ•°+1
t3: 2.5 < 3.0 ä½† ä¸Šæ¬¡(2.8) < 3.0 â†’ ä¸è§¦å‘
```

#### ä»£ç å®ç°
```c
// æ­¥éª¤1ï¼šä¿å­˜æ—§å€¼
Voltage_Old = Voltage_Real;

// æ­¥éª¤2ï¼šè®¡ç®—æ–°å€¼
Voltage_Real = æ–°è¾“å…¥çš„å››èˆäº”å…¥å€¼;

// æ­¥éª¤3ï¼šä¸‹é™æ²¿æ£€æµ‹
Voltage_Setting = é˜ˆå€¼;
if((Voltage_Real < Voltage_Setting) && (Voltage_Old >= Voltage_Setting))
{
    Voltage_Count++;  // è§¦å‘è®¡æ•°
}
```

---

### 3. æŒ‰é”®è¾¹æ²¿æ£€æµ‹ç®—æ³•

#### ç®—æ³•åŸç†
é€šè¿‡å¼‚æˆ–è¿ç®—æ£€æµ‹æŒ‰é”®çŠ¶æ€å˜åŒ–ã€‚

#### é€»è¾‘æ¨å¯¼
```c
// ä¸‹é™æ²¿ï¼ˆæŒ‰é”®æŒ‰ä¸‹ç¬é—´ï¼‰
Key_Down = Key_Val & (Key_Val ^ Key_Old)

çœŸå€¼è¡¨ï¼š
Key_Old | Key_Val | Key_Val^Key_Old | Key_Down
--------|---------|-----------------|----------
   0    |    0    |        0        |    0     (æŒç»­æœªæŒ‰)
   0    |    1    |        1        |    1     (æŒ‰ä¸‹ç¬é—´) âœ“
   1    |    0    |        1        |    0     (é‡Šæ”¾ç¬é—´)
   1    |    1    |        0        |    0     (æŒç»­æŒ‰ä¸‹)
```

#### åº”ç”¨åœºæ™¯
```c
if(Key_Down == 11)  // æ£€æµ‹æŒ‰é”®11æŒ‰ä¸‹ç¬é—´
{
    // æ‰§è¡Œä¸€æ¬¡æ€§æ“ä½œï¼ˆä¸ä¼šé‡å¤è§¦å‘ï¼‰
}
```

---

### 4. é—ªçƒæ˜¾ç¤ºç®—æ³•

#### ç®—æ³•åŸç†
é€šè¿‡å®šæ—¶ç¿»è½¬æ ‡å¿—ä½ï¼Œæ§åˆ¶æ˜¾ç¤ºä½çš„äº®/ç­ã€‚

#### ä»£ç å®ç°
```c
// å®šæ—¶å™¨ä¸­æ–­ï¼ˆ1msï¼‰
if(++Timer250 == 250)
{
    Timer250 = 0;
    Input_Flag ^= 1;  // æ¯250msç¿»è½¬ä¸€æ¬¡
}

// æ˜¾ç¤ºå¤„ç†
if(Voltage_Input_Index < 4 && Input_Flag == 1)
{
    Seg_Buf[Voltage_Input_Index + 2] = 10;  // é—ªçƒä½ç†„ç­
}
```

#### æ—¶åºç¤ºä¾‹
```
æ—¶é—´(ms)   0    250   500   750   1000
----------------------------------------
Input_Flag 0     1     0     1     0
æ˜¾ç¤ºçŠ¶æ€   äº®    ç­    äº®    ç­    äº®
```

---

## ä½¿ç”¨è¯´æ˜

### æ“ä½œæµç¨‹

#### 1. ç”µå‹æ•°æ®é‡‡é›†
1. **å¼€æœºé»˜è®¤è¿›å…¥æ¨¡å¼0**ï¼ˆæ•°ç ç®¡æ˜¾ç¤º `------`ï¼‰
2. **æŒ‰æ•°å­—é”®è¾“å…¥4ä½ç”µå‹å€¼**ï¼ˆä¾‹å¦‚ï¼š3â†’4â†’5â†’6 æ˜¾ç¤º `--3.456`ï¼‰
3. **å½“å‰è¾“å…¥ä½æ¯250msé—ªçƒä¸€æ¬¡**
4. **æŒ‰ç¡®è®¤é”®(11)**ï¼š
   - è¾“å…¥ä¸æ»¡4ä½ â†’ LED2ç‚¹äº®ï¼ˆæŠ¥é”™ï¼‰
   - è¾“å…¥æ»¡4ä½ â†’ è¿›å…¥æ¨¡å¼1æ˜¾ç¤ºç»“æœ

#### 2. æŸ¥çœ‹æ•°æ®ï¼ˆæ¨¡å¼1ï¼‰
- æ•°ç ç®¡æ˜¾ç¤º `U--X.XX`ï¼ˆå››èˆäº”å…¥åçš„3ä½æ•°æ®ï¼‰
- ç¤ºä¾‹ï¼šè¾“å…¥ `3.456` â†’ æ˜¾ç¤º `U--3.46`
- æŒ‰ç¡®è®¤é”®(11)è¿”å›æ¨¡å¼0

#### 3. è®¾ç½®é˜ˆå€¼ï¼ˆæ¨¡å¼2ï¼‰
1. åœ¨æ¨¡å¼1æŒ‰ **æ¨¡å¼åˆ‡æ¢é”®(12)** è¿›å…¥æ¨¡å¼2
2. æ•°ç ç®¡æ˜¾ç¤º `P--X.X0`ï¼ˆå½“å‰é˜ˆå€¼ï¼‰
3. æŒ‰ **å¢åŠ é”®(15)** æˆ– **å‡å°‘é”®(16)** è°ƒèŠ‚é˜ˆå€¼
   - æ­¥è¿›ï¼š0.5V
   - èŒƒå›´ï¼š1.0V ~ 6.0V
   - è¶…å‡ºèŒƒå›´è‡ªåŠ¨å¾ªç¯
4. æŒ‰ç¡®è®¤é”®(11)è¿”å›æ¨¡å¼0

#### 4. æŸ¥çœ‹è®¡æ•°ï¼ˆæ¨¡å¼3ï¼‰
1. åœ¨æ¨¡å¼1/2æŒ‰ **æ¨¡å¼åˆ‡æ¢é”®(12)** å¾ªç¯åˆ°æ¨¡å¼3
2. æ•°ç ç®¡æ˜¾ç¤º `NXXXXX`ï¼ˆä¸‹é™æ²¿è®¡æ•°å€¼ï¼‰
3. æŒ‰ç¡®è®¤é”®(11)è¿”å›æ¨¡å¼0

---

### LED æŒ‡ç¤ºè¯´æ˜

#### LED0 - ç³»ç»Ÿè®¡æ—¶æŒ‡ç¤º
- **ç‚¹äº®æ¡ä»¶**ï¼šç”µå‹ä½äºé˜ˆå€¼æ—¶é—´ â‰¥ 5ç§’
- **ç”¨é€”**ï¼šæŒ‡ç¤ºä½å‹æŒç»­æ—¶é—´

#### LED1 - è®¡æ•°å¥‡å¶æŒ‡ç¤º
- **ç‚¹äº®æ¡ä»¶**ï¼šä¸‹é™æ²¿è®¡æ•°ä¸ºå¥‡æ•°
- **ç”¨é€”**ï¼šå¿«é€Ÿåˆ¤æ–­è®¡æ•°å¥‡å¶æ€§

#### LED2 - é”™è¯¯æŠ¥è­¦
- **ç‚¹äº®æ¡ä»¶**ï¼šæŒ‰é”®æ“ä½œé”™è¯¯ç´¯è®¡3æ¬¡
- **é”™è¯¯ç¤ºä¾‹**ï¼š
  - åœ¨æ¨¡å¼1/2/3æŒ‰æ•°å­—é”®
  - åœ¨æœªè¾“å…¥æ»¡4ä½æ—¶æŒ‰ç¡®è®¤é”®
  - åœ¨æ¨¡å¼0æŒ‰æ¨¡å¼åˆ‡æ¢é”®
- **æ¸…é™¤æ–¹æ³•**ï¼šæ‰§è¡Œæ­£ç¡®æ“ä½œæ—¶è‡ªåŠ¨æ¸…é›¶

---

### å¸¸è§é—®é¢˜

#### Q1: è¾“å…¥æ•°æ®åæŒ‰ç¡®è®¤é”®æ²¡ååº”ï¼Ÿ
**A:** æ£€æŸ¥æ˜¯å¦è¾“å…¥æ»¡4ä½æ•°æ®ï¼ŒLED2æ˜¯å¦ç‚¹äº®ï¼ˆé”™è¯¯æŠ¥è­¦ï¼‰

#### Q2: ä¸‹é™æ²¿ä¸ºä»€ä¹ˆæ²¡æœ‰è®¡æ•°ï¼Ÿ
**A:** æ£€æŸ¥ä»¥ä¸‹æ¡ä»¶ï¼š
- æ–°ç”µå‹å€¼æ˜¯å¦ < é˜ˆå€¼
- ä¸Šæ¬¡ç”µå‹å€¼æ˜¯å¦ â‰¥ é˜ˆå€¼
- æ˜¯å¦åœ¨æ¨¡å¼2æ­£ç¡®è®¾ç½®äº†é˜ˆå€¼

#### Q3: æ•°ç ç®¡é—ªçƒé¢‘ç‡å¼‚å¸¸ï¼Ÿ
**A:** æ£€æŸ¥å®šæ—¶å™¨åˆå€¼æ˜¯å¦æ­£ç¡®ï¼ˆTH0=0xFC, TL0=0x18ï¼‰

#### Q4: LED2ä¸€ç›´äº®ç€ï¼Ÿ
**A:** æŒ‰é”®æ“ä½œé”™è¯¯ç´¯è®¡3æ¬¡åï¼Œéœ€æ‰§è¡Œæ­£ç¡®æ“ä½œæ‰èƒ½æ¸…é›¶

---

## æŠ€æœ¯ç‰¹ç‚¹

### ä¼˜ç‚¹
âœ… **çŠ¶æ€æœºè®¾è®¡æ¸…æ™°**ï¼š4ç§æ¨¡å¼é€»è¾‘åˆ†æ˜
âœ… **é˜²é”™æœºåˆ¶å®Œå–„**ï¼šé”™è¯¯è®¡æ•°ã€è¶Šç•Œä¿æŠ¤
âœ… **ç”¨æˆ·ä½“éªŒå‹å¥½**ï¼šé—ªçƒæç¤ºã€LEDæŒ‡ç¤º
âœ… **ç®—æ³•ä¸¥è°¨**ï¼šå››èˆäº”å…¥ã€ä¸‹é™æ²¿æ£€æµ‹æ— è¯¯

### å¯ä¼˜åŒ–ç‚¹
ğŸ”§ **ä»£ç å¤ç”¨æ€§**ï¼šå››èˆäº”å…¥é€»è¾‘åœ¨ä¸¤å¤„é‡å¤
ğŸ”§ **å‚æ•°é…ç½®**ï¼šè°ƒèŠ‚æ­¥è¿›å¯æ”¹ä¸ºå˜é‡
ğŸ”§ **è®¡æ•°èŒƒå›´**ï¼šå½“å‰æœ€å¤§99999ï¼Œå¯æ‰©å±•

---

## ç‰ˆæœ¬ä¿¡æ¯

- **åˆ›å»ºæ—¥æœŸ**ï¼š2026-01-28
- **èŠ¯ç‰‡å‹å·**ï¼šSTC89C52
- **æ™¶æŒ¯é¢‘ç‡**ï¼š12MHz
- **ç¼–è¯‘ç¯å¢ƒ**ï¼šKeil C51

---

## é™„å½•

### æ•°ç ç®¡ç¼–ç è¡¨

| æ•°å€¼ | Seg_Buf | æ˜¾ç¤º |
|------|---------|------|
| 0-9 | 0-9 | 0-9 |
| 10 | 10 | ç†„ç­ |
| 13 | 13 | - (æ¨ªçº¿) |
| 14 | 14 | U |
| 15 | 15 | P |
| 16 | 16 | N |

### å¼•è„šå®šä¹‰ï¼ˆéœ€å‚è€ƒåº•å±‚é©±åŠ¨ï¼‰
- **æ•°ç ç®¡**ï¼šæ®µç  + ä½é€‰ï¼ˆåŠ¨æ€æ‰«æï¼‰
- **æŒ‰é”®**ï¼šçŸ©é˜µé”®ç›˜ï¼ˆ4Ã—4ï¼‰
- **LED**ï¼šP1å£æˆ–P2å£ï¼ˆéœ€æŸ¥çœ‹Led.hï¼‰

---

**æ–‡æ¡£ç»“æŸ**
